function BPBMcheckPushWorkerStatus(){"serviceWorker"in navigator&&"PushManager"in window?navigator.serviceWorker.register("/bpbm-worker.js",{scope:"/"}).then(function(e){e.pushManager.getSubscription().then(function(e){null===e?(BPBMJQ(".BPBMenablePushNotifications").show(),BPBMJQ(".BPBMdisablePushNotifications").hide()):(BPBMJQ(".BPBMenablePushNotifications").hide(),BPBMJQ(".BPBMdisablePushNotifications").show(),BPBMJQ.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_save_user_push_subscription",nonce:BP_Messages.savePushNotificationsNonce,sub:JSON.stringify(e)}))})}):BPBMJQ(".BPBMpushNotifications").hide()}function BPBMregisterPushWorker(){"serviceWorker"in navigator&&"PushManager"in window&&navigator.serviceWorker.register("/bpbm-worker.js",{scope:"/"}).then(function(e){e.pushManager.getSubscription().then(function(s){null===s&&e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:BPBMurlBase64ToUint8Array(BP_Messages.vapidPublicKey)}).then(function(e){BPBMJQ.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_save_user_push_subscription",nonce:BP_Messages.savePushNotificationsNonce,sub:JSON.stringify(e)}),BPBMJQ(".BPBMenablePushNotifications").hide(),BPBMJQ(".BPBMdisablePushNotifications").show()}).catch(function(e){BBPMShowError(e)})})})}function BPBMunregisterPushWorker(){"serviceWorker"in navigator&&"PushManager"in window&&navigator.serviceWorker.register("/bpbm-worker.js",{scope:"/"}).then(function(e){e.pushManager.getSubscription().then(function(e){null!==e&&e.unsubscribe().then(function(s){BPBMJQ.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_delete_user_push_subscription",nonce:BP_Messages.savePushNotificationsNonce,sub:JSON.stringify(e)}),BPBMJQ(".BPBMenablePushNotifications").show(),BPBMJQ(".BPBMdisablePushNotifications").hide()}).catch(function(e){})})})}function BPBMurlBase64ToUint8Array(e){for(var s=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),a=window.atob(s),t=new Uint8Array(a.length),i=0;i<a.length;++i)t[i]=a.charCodeAt(i);return t}function BBPMNotice(e){BPBMJQ.amaran({theme:"colorful",content:{bgcolor:"black",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:1e4,position:"bottom right"})}function BBPMShowError(e){BPBMJQ.amaran({theme:"colorful",content:{bgcolor:"#c0392b",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:1e4,position:"bottom right"})}function BBPMOpenMiniChat(e,s){BPBMJQ(document).trigger("bp-better-messages-open-mini-chat",[e,s])}function BBPMOpenPrivateThread(e){BPBMJQ(document).trigger("bp-better-messages-open-private-thread",[e])}var BPBMJQ=jQuery.noConflict();BPBMJQ.fn.bpbmtooltip=jQuery.fn.tooltip,function(e){function s(s){var a=parseInt(s);isNaN(a)&&(a=0),document.dispatchEvent(new CustomEvent("bp-better-messages-update-unread",{detail:{unread:a}})),BP_Messages.total_unread=a,0===a&&e(".bp-messages-wrap .threads-list .thread .unread-count").html(""),"1"===BP_Messages.titleNotifications&&(isNaN(a)||a<=0?document.title=re:document.title="("+s+") "+re)}function a(s){void 0!==s[0].BPemojioneArea&&s[0].BPemojioneArea.trigger("change");var a=s.val();if(0===e(s).next(".bp-emojionearea").length)return a;var t=function(s){"<p>"!==(s=s.replace(/<p><\/p>/g,"")).substring(0,3)&&(s="<p>"+s);"</p>"!==s.substring(s.length-4)&&(s+="</p>");var a=e.parseHTML(s);e.each(a,function(s,a){var t=e(this);e.each(t.find("img.emojioneemoji,img.emojione"),function(){var s=e(this);s.replaceWith(s.attr("alt"))}),t.BPBMremoveAttributes(),t.find("*").BPBMremoveAttributes()});var t="";e.each(a,function(){t+=this.outerHTML}),"<p></p>"===t&&(t="");return t=t.replace(/&amp;/g,"&")}(a);return s.val(t),t}function t(){"function"==typeof e.fn.BPBMmagnificPopup&&e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").each(function(){var s=e(this),a=s.closest("li");s.BPBMmagnificPopup({delegate:"a",key:a.attr("data-id"),type:"image",gallery:{enabled:!0}})})}function i(s){if(0===s.length)return!1;0===e("."+fe).length&&e('<div class="'+fe+'"></div>').insertBefore(s);var a=s;a.addClass("bp-messages-mobile"),a.attr("id","bp-better-messages-mobile-view-container");var t=window.innerHeight;e("html").addClass("bp-messages-mobile").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",t);var i=a.appendTo(e("body"));i.show();var n=0;n+=i.find(".chat-header").outerHeight(),i.find(".chat-footer:visible").length>0&&(n+=i.find(".chat-footer:visible").outerHeight()),i.find(".reply").length>0&&(n+=i.find(".reply").outerHeight());var r=t-n;i.find(".scroller").css({"max-height":"",height:r}),A(i),v(),J(),e(document).trigger("bp-better-messages-mobile-open"),ee=!0}function n(s){e.each(s,function(){var s=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+this+'"]'),a=s.closest(".messages-stack");s.remove();0===a.find(".messages-list > li").length&&a.remove(),e(de+'[data-message="'+this+'"] .info p').text("...")})}function r(){e.each($,function(s,a){var t=e(a);if(t.hasClass("bp-messages-wrap-main")){var i=t.find("> .bp-messages-threads-wrapper .bp-messages-side-threads");if(i.length>0){var n=i.closest(".bp-messages-threads-wrapper"),r=2*i.width();r<800&&(r=800),t.width()<r?(n.addClass("threads-hidden"),i.hide()):(n.removeClass("threads-hidden"),i.show())}}if(t.hasClass("bp-messages-mobile")){var o=window.innerHeight,l=0;l+=t.find(".chat-header").outerHeight(),t.find(".chat-footer:visible").length>0&&(l+=t.find(".chat-footer:visible").outerHeight()),t.find(".reply").length>0&&(l+=t.find(".reply").outerHeight()),t.find(".scroller").css({height:o-l})}else!function(){var s=e(window).height()-50,a=e("#wpadminbar");a.length>0&&a.is(":visible")&&(s-=a.height());var t=s;s>BP_Messages.max_height&&(s=BP_Messages.max_height),s=parseInt(s),BPBMJQ(".bp-messages-wrap .scroller").each(function(){var a=e(this),i=a.closest(".bp-messages-column"),n=a.closest(".bp-messages-wrap");if(n.hasClass("bp-better-messages-mini")){var r=BP_Messages.miniChatsHeight,o=n.find(".reply").outerHeight();r>t&&(r=t-o-10),a.css("max-height",r),a.css("height",r)}else if(n.hasClass("bp-better-messages-list")){var l=BP_Messages.miniWindowsHeight;if(l>t){l=t-10;var c=a.closest(".messages");if(c.length>0){var d=c.find(".chat-header");d.length>0&&(l-=d.outerHeight())}}a.css("max-height",l),a.css("height",l)}else if(i.length>0&&i.parent().find(".bp-messages-side-threads").is(":visible"))(p=a.closest(".bp-messages-threads-wrapper")).css("max-height",s),p.css("height",s);else{var p=a.closest(".bp-messages-threads-wrapper");p.css("max-height",s),p.css("height",s)}}),BPBMJQ(".bp-messages-wrap.bp-better-messages-list .scroller").css("max-height",s-50),BPBMJQ(".bp-messages-wrap.bp-better-messages-mini .scroller").css("max-height",s-50)}()})}function o(){function a(){BPBMJQ(".bp-messages-wrap .scroller.thread").show(),BPBMJQ(".bp-messages-wrap .bp-messages-call-container").hide();var e=BPBMJQ(".bp-messages-wrap .bp-messages-video-container .bp-messages-main-video"),s=BPBMJQ(".bp-messages-wrap .bp-messages-video-container .bp-messages-small-video");e.hide(),e.html(""),s.hide(),s.html(""),BPBMJQ(".bp-messages-wrap .reply").show(),BPBMJQ(".bp-messages-call-controls").hide(),BPBMJQ(".bp-messages-call-controls .bpbm-enable-mic").hide(),BPBMJQ(".bp-messages-call-controls .bpbm-disable-mic").show(),BPBMJQ(".bp-messages-call-controls .bpbm-enable-video").hide(),BPBMJQ(".bp-messages-call-controls .bpbm-disable-video").show(),clearInterval(A),!1!==j&&j.getTracks().forEach(function(e){try{j.removeTrack(e),e.stop()}catch(e){}}),!1!==S&&S.close(),j=!1,E=!1,I=!1,S=!1,ie=!1,clearInterval(K),clearInterval(ee)}function t(){if("dnd"===BP_Messages.userStatus)return!1;he.calling.playing()||he.calling.play()}function r(){he.calling.playing()&&he.calling.stop()}function o(e,s,a){if(e||(e={audio:!0,video:!0}),!s)throw"Second argument is mandatory. navigator.getUserMedia(hints,onsuccess,onfailure)";navigator.mediaDevices.getUserMedia(e).then(function(e){s(e)}).catch(function(e){if(!a)throw Error("getUserMedia failed: "+JSON.stringify(e,null,"\t"));a(e)})}function d(){if(!1!==S)return!1;try{var s=BP_Messages.turn_server;(S=new ae({iceServers:[{urls:["turns:"+s,"turn:"+s],username:"wordplus",credential:"password"},{urls:"stun:"+s,username:"wordplus",credential:"password"},{urls:"stun:stun.l.google.com:19302"}]})).peers={},S.onicecandidate=function(e){e.candidate&&W.emit("mediaEvent",{event:"ice_message",candidate:e.candidate,to:S.participant})},S.oniceconnectionstatechange=function(e){"failed"!==S.iceConnectionState&&"disconnected"!==S.iceConnectionState&&"closed"!==S.iceConnectionState||(a(),BBPMNotice(BP_Messages.strings.connection_drop))},S.onice=function(e){if(S.peers[e.from]){S.addIceCandidate(e.candidate);for(var s=0;s<z.length;s++)S.addIceCandidate(z[s]);z=[]}else z.push(z)},S.ontrack=function(s){var a=!1;s.streams&&s.streams[0]?a=s.streams[0]:(L||(a=L=new MediaStream),L.addTrack(s.track)),"video"===s.track.kind&&function(s){d();var a=document.createElement("video");a.setAttribute("playsinline","true");var t=e(".bp-messages-video-container");t.find(".bp-messages-main-video").html(a),t.show(),a.srcObject=s,a.muted=!1,a.controls=!1,a.playsinline=!0,a.play(),_(t)}(a),"audio"===s.track.kind&&function(s){d();var a=document.createElement("audio");a.setAttribute("playsinline","true");e(".bp-messages-audio-element").html(a),a.srcObject=s,a.muted=!1,a.controls=!1,a.playsinline=!0,a.autoplay=!0,a.play()}(a)}}catch(e){console.error(e)}}function p(s){d();var a=document.createElement("video");a.setAttribute("playsinline","true");var t=e(".bp-messages-video-container");t.find(".bp-messages-small-video").show(),t.find(".bp-messages-small-video").html(a),t.show(),a.srcObject=s,a.controls=!0,a.muted=!0,a.controls=!1,a.playsinline=!0,a.play()}function m(){q=setTimeout(function(){g()},se),G=setInterval(function(){ne++},1e3)}function g(){if(clearTimeout(q),clearInterval(G),0===ne)return!1;var s=ne+1;ne=0;var a=BPBMJQ(S.container),t=!1;a.hasClass("bp-messages-audio-container")?t="audio":a.hasClass("bp-messages-video-container")&&(t="video");var i=a.closest("[data-thread-id]").attr("data-thread-id"),n=a.find(".bpbm-cancel");n.hasClass("bpbm-blocked")?n.removeClass("bpbm-blocked"):n.click(),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_record_missed_call",thread_id:i,type:t,duration:s})}function h(){clearTimeout(q),clearInterval(G),ne=0,K=setInterval(function(){oe++},1e3);var s=BPBMJQ(S.container),a=!1;s.hasClass("bp-messages-audio-container")?a="audio":s.hasClass("bp-messages-video-container")&&(a="video");var t=s.closest("[data-thread-id]").attr("data-thread-id");e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_register_started_call",thread_id:t,type:a},function(e){S.call_message_id=e}),ee=setInterval(function(){e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_register_call_usage",call_message_id:S.call_message_id,duration:oe})},1e3*re)}function b(s,a,t){BBPMShowError(BP_Messages.strings.call_offline),"1"===BP_Messages.offlineCallsNotifications&&e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_record_offline_call",type:s,thread_id:a,user_id:t})}function u(s){var a=BPBMJQ(s).data("user-id");if(W.connected){if(ie)return!1;void 0===navigator.mediaDevices?BBPMShowError(BP_Messages.strings.no_webrtc):-1===X.indexOf(a.toString())?Z?b("video",N,a):setTimeout(function(){u(s)},500):B(function(s,t,i){if(!1!==i){console.error(i);var n=i.toString().split(":");BBPMShowError(BP_Messages.strings.cam_not_works+": "+n[1])}else{var r=e(".bp-messages-video-container");j=s,E=t,t.controls=!1,t.autoplay=!0,t.muted=!0,t.playsinline=!0,t.onplaying=function(){_(r)},r.find(".bp-messages-placeholder-video").html(t),t.play(),ie=!0,m(),d(),S.participant=a,S.container=r;var o=r.closest(".bp-messages-wrap"),l=r.data("my-avatar"),c=r.data("my-name");v(o),o.find(".scroller.thread").hide(),r.show(),r.find(".bp-messages-placeholder-message > *").hide(),r.find(".bp-messages-placeholder-message > .bp-messages-placeholder-outgoing-text").show(),r.find(".bp-messages-call-controls > *").hide(),r.find(".bp-messages-call-controls").show(),r.find(".bp-messages-call-controls > .bpbm-call-out").show(),r.find(".bp-messages-main-placeholder").show(),W.emit("mediaEvent",{event:"calling",to:a,thread_id:N,avatar:l,name:c}),A=setInterval(function(){W.emit("mediaEvent",{event:"calling",to:a,thread_id:N,avatar:l,name:c})},2500),_(r)}})}else BBPMNotice(BP_Messages.strings.websocket_not_connected)}function f(s){var a=BPBMJQ(s).data("user-id");if(W.connected){if(ie)return!1;void 0===navigator.mediaDevices?BBPMShowError(BP_Messages.strings.no_webrtc):-1===X.indexOf(a.toString())?Z?b("audio",N,a):setTimeout(function(){f(s)},500):w(function(s,t,i){if(!1!==i){console.error(i);var n=i.toString().split(":");BBPMShowError(BP_Messages.strings.mic_not_works+": "+n[1])}else{m(),ie=!0,d();var r=e(".bp-messages-audio-container");S.participant=a,S.container=r,j=s,I=t;var o=r.closest(".bp-messages-wrap");v(o);var l=r.data("my-avatar"),c=r.data("my-name");o.find(".scroller.thread").hide(),r.find(".bp-messages-placeholder-message > *").hide(),r.find(".bp-messages-placeholder-message > .bp-messages-placeholder-outgoing-text").show(),r.find(".bp-messages-call-controls > *").hide(),r.find(".bp-messages-call-controls").show(),r.find(".bp-messages-call-controls > .bpbm-call-out").show(),r.find(".bp-messages-main-placeholder").show(),r.show(),W.emit("mediaEvent",{event:"calling_audio",to:a,thread_id:N,avatar:l,name:c}),A=setInterval(function(){W.emit("mediaEvent",{event:"calling_audio",to:a,thread_id:N,avatar:l,name:c})},2500)}})}else BBPMNotice(BP_Messages.strings.websocket_not_connected)}function v(e){var s=e.find(".scroller.thread"),a=s.height(),t=e.find(".reply"),i=a+=t.outerHeight();s.parent().hasClass("bp-messages-column")&&(i=a=e.height()-e.find(".chat-header").height()),a>i&&(a=i),t.hide()}function _(e){var s=e.closest(".bp-messages-wrap"),a=(s.find(".scroller.thread").height(),s.find(".reply"));if(a.outerHeight(),e.find(".bp-messages-main-placeholder").is(":visible")){e.find(".bp-messages-main-placeholder");a.hide()}}function B(e){o({audio:!0,video:{minWidth:480,minHeight:240,maxWidth:1920,maxHeight:1080,facingMode:F?"user":"environment"}},function(s){var a=document.createElement("video");a.srcObject=s,a.controls=!0,a.muted=!0,a.setAttribute("playsinline","true"),function(){var e=BPBMJQ(".bp-messages-wrap .bpbm-switch-camera-video"),s=BPBMJQ(".bp-messages-wrap .bpbm-switch-full-screen");be?s.hide():s.show(),navigator.mediaDevices.enumerateDevices().then(function(s){var a=[];BPBMJQ.each(s,function(e,s){"videoinput"===s.kind&&a.push(s)}),a.length>1?e.show():e.hide()}).catch(function(e){console.error(e)})}(),e(s,a,!1)},function(s){s&&e(null,null,s)})}function w(e){o({audio:!0,video:!1},function(s){var a=document.createElement("audio");a.srcObject=s,a.controls=!0,a.muted=!0,a.setAttribute("playsinline","true"),e(s,a,!1)},function(s){s&&e(null,null,s)})}function T(){var s=[],a=[];e(".bp-messages-wrap:not(.bp-better-messages-mini) .list .messages-stack .content .messages-list li.unread:not(.fast),.bp-messages-wrap.bp-better-messages-mini .chat.open .list .messages-stack .content .messages-list li.unread:not(.fast)").each(function(){var t=e(this);if(t.is(":visible")){var i=t.data("id"),n=t.data("thread"),r=t.attr("data-time");s.push(i),a.push(n),t.removeClass("unread"),U("bp-better-messages-thread-"+n,r,1)}}),s.length>0&&W.emit("seen",s),a=l(a),e.each(a,function(e,s){void 0!==s&&W.emit("threadOpen",s)})}try{W=bpbmio.connect(BP_Messages.socket_server,{upgrade:!0,rememberUpgrade:!0,secure:!0,transports:["websocket"]})}catch(e){return console.error("Error connecting to the WebSocket Server. Please contact plugin developer. https://www.wordplus.org/contact/"),BP_Messages.realtime="0",!1}W.on("connect_error",function(e){console.debug("Error while connecting to WebSocket messaging server. AJAX mode enabled."),BP_Messages.realtime="0"}),W.on("connect",function(){W.emit("authentication",BP_Messages.site_id,BP_Messages.user_id,BP_Messages.secret_key),console.debug("You was connected to WebSocket messaging server. WebSocket mode enabled."),BP_Messages.realtime="1"}),W.on("disconnect",function(){console.debug("You was disconnected from WebSocket messaging server. AJAX mode enabled."),BP_Messages.realtime="0"}),W.on("reconnect",function(){console.debug("You was reconnected to WebSocket messaging server. WebSocket mode enabled."),BP_Messages.realtime="1"}),W.on("userStatus",function(s,a){BP_Messages.user_id===s&&(BP_Messages.userStatus=a.slug),"0"!==BP_Messages.userStatus&&e('.bbpm-avatar[data-user-id="'+s+'"]').css("color",a.color)});var S=!1,j=!1,E=!1,I=!1,L=!1,A=!1,z=[];BPBMJQ(document).on("bpbm-end-call",a),BPBMJQ(window).on("beforeunload",function(){if(ie)return BP_Messages.strings.you_are_in_call});var H={},$={},F=!0,Y={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};W.on("mediaEvent",function(s){var n=e(".bp-messages-video-container"),o=n.closest(".bp-messages-wrap");switch(s.event){case"answered":d(),clearInterval(A),o.find(".bp-messages-main-placeholder").hide(),o.find(".bp-messages-main-placeholder .bp-messages-placeholder-video").html(""),o.find(".bp-messages-main-video").show(),n.find(".bp-messages-call-controls > *").hide(),n.find(".bp-messages-call-controls").show(),n.find(".bp-messages-call-controls > .bpbm-call-in-progress").show(),p(j),ie=!0,h();break;case"answered_call":n=e(".bp-messages-audio-container"),d(),clearInterval(A),(o=n.closest(".bp-messages-wrap")).find(".bp-messages-placeholder-incoming-text, .bp-messages-placeholder-outgoing-text").hide();var l=o.find(".bp-messages-timer");l.show(),l.runner({format:function(e){return O(e)},milliseconds:!1}),l.runner("start"),n.find(".bp-messages-call-controls > *").hide(),n.find(".bp-messages-call-controls").show(),n.find(".bp-messages-call-controls > .bpbm-call-in-progress").show(),n.find(".bp-messages-call-controls > *").hide(),n.find(".bp-messages-call-controls").show(),n.find(".bp-messages-call-controls > .bpbm-call-in-progress").show(),ie=!0,h();break;case"rejected":BBPMNotice(BP_Messages.strings.call_reject),clearInterval(A),ie=!1,g(),a();break;case"calling":if(ie)return!1;if(void 0!==H[s.from])return!1;if(d(),t(),N&&s.thread_id===N.toString()){o.find(".scroller.thread").hide(),v(o),n.show(),n.find(".bp-messages-placeholder-message > *").hide(),n.find(".bp-messages-placeholder-message > .bp-messages-placeholder-incoming-text").show(),n.find(".bp-messages-call-controls > *").hide(),n.find(".bp-messages-call-controls").show(),n.find(".bp-messages-call-controls > .bpbm-call-in").show(),n.find(".bp-messages-main-placeholder").show();(c=e(".bp-messages-wrap.bp-messages-wrap-main.mobile-ready:not(.bp-messages-mobile)")).length>0&&(i(o),v(o)),!1===E?B(function(e,s,a){if(!1!==a){console.error(a);var t=a.toString().split(":");BBPMShowError(BP_Messages.strings.cam_not_works+": "+t[1])}else j=e,E=s,n.find(".bp-messages-placeholder-video").html(E),E.controls=!1,E.play()}):(n.find(".bp-messages-placeholder-video").html(E),E.controls=!1,E.play())}else{0===(b=e(".amaran.incoming_call.thread_"+s.thread_id)).length&&e.amaran({theme:"user message thread_"+s.thread_id+" incoming_call",content:{img:s.avatar,user:s.name,message:'<div style="float: left;height: 35px;line-height: 35px;">'+BP_Messages.strings.incoming_call+'</div><div class="bp-messages-wrap bp-messages-popup"><div class="bpbm-call-in"><span class="bpbm-answer" data-thread-id="'+s.thread_id+'"  data-user-id="'+s.from+'" title="'+BP_Messages.strings.answer_call+'"><i class="fas fa-phone"></i></span><span class="bpbm-reject" data-thread-id="'+s.thread_id+'"  data-user-id="'+s.from+'" title="'+BP_Messages.strings.reject_call+'"><i class="fas fa-phone"></i></span></div></div>'},sticky:!0,closeOnClick:!1,closeButton:!1,delay:999999,thread_id:s.thread_id,position:"bottom right",onClick:function(){}})}void 0!==$[s.from]&&clearTimeout($[s.from]),$[s.from]=setTimeout(function(){r(),a();var s=e(".amaran.incoming_call");s.length>0&&s.remove()},3e3);break;case"calling_audio":if(ie)return!1;if(void 0!==H[s.from])return!1;if(d(),n=e(".bp-messages-audio-container"),t(),N&&s.thread_id===N.toString()){o.find(".scroller.thread").hide(),v(o),n.show(),n.find(".bp-messages-placeholder-message > *").hide(),n.find(".bp-messages-placeholder-message > .bp-messages-placeholder-incoming-text").show(),n.find(".bp-messages-call-controls > *").hide(),n.find(".bp-messages-call-controls").show(),n.find(".bp-messages-call-controls > .bpbm-call-in").show(),n.find(".bp-messages-main-placeholder").show();var c=e(".bp-messages-wrap.bp-messages-wrap-main.mobile-ready");c.length>0&&i(o),!1===I?w(function(e,s,a){if(!1!==a){console.error(a);var t=a.toString().split(":");BBPMShowError(BP_Messages.strings.cam_not_works+": "+t[1])}else j=e,(I=s).controls=!1,I.play()}):(I.controls=!1,I.play())}else{0===(b=e(".amaran.incoming_call.thread_"+s.thread_id)).length&&e.amaran({theme:"user message thread_"+s.thread_id+" incoming_call",content:{img:s.avatar,user:s.name,message:'<div style="float: left;height: 35px;line-height: 35px;">'+BP_Messages.strings.incoming_call+'</div><div class="bp-messages-wrap bp-messages-popup"><div class="bpbm-call-in"><span class="bpbm-answer" data-thread-id="'+s.thread_id+'"  data-user-id="'+s.from+'" title="'+BP_Messages.strings.answer_call+'"><i class="fas fa-phone"></i></span><span class="bpbm-reject" data-thread-id="'+s.thread_id+'"  data-user-id="'+s.from+'" title="'+BP_Messages.strings.reject_call+'"><i class="fas fa-phone"></i></span></div></div>'},sticky:!0,closeOnClick:!1,closeButton:!1,delay:999999,thread_id:s.thread_id,position:"bottom right",onClick:function(){}})}void 0!==$[s.from]&&clearTimeout($[s.from]),$[s.from]=setTimeout(function(){r(),a();var s=e(".amaran.incoming_call");s.length>0&&s.remove()},3e3);break;case"offer":d();var m=new te(s.sdp);S.peers[s.from]=S.setRemoteDescription(m).then(function(){return j}).then(function(e){j.getTracks().forEach(function(e){S.addTrack(e,j)})}).then(function(){return S.createAnswer()}).then(function(e){return S.setLocalDescription(e)}).then(function(){W.emit("mediaEvent",{event:"answer",to:s.from,sdp:S.localDescription})});break;case"answer":d(),S.setRemoteDescription(new te(s.sdp));break;case"self_reject":r();(b=e(".amaran.incoming_call")).length>0&&b.remove(),H[s.from]="1",setTimeout(function(){delete H[s.from]},3e3);break;case"call_cancelled":r();var b=e(".amaran.incoming_call.thread_"+s.thread_id);b.length>0&&b.remove(),H[s.from]="1",setTimeout(function(){delete H[s.from]},3e3),a();break;case"call_end":a();break;case"ice_message":S.onice(s)}});var q,G,K,ee,se=1e3*BP_Messages.callRequestTimeLimit,ne=0,re=5,oe=0;BPBMJQ(document).on("click",".bp-messages-wrap .chat-header .video-call",function(e){e.preventDefault(),e.stopImmediatePropagation(),u(this)}),BPBMJQ(document).on("click",".bp-messages-wrap .chat-header .audio-call",function(e){e.preventDefault(),e.stopImmediatePropagation(),f(this)}),BPBMJQ(document).on("click","#bpbm-audio-call .bpbm-audio-call",function(e){var s=BPBMJQ(this).data("user-id");-1===X.indexOf(s.toString())&&(e.preventDefault(),e.stopImmediatePropagation(),BBPMShowError(BP_Messages.strings.call_offline))}),BPBMJQ(document).on("click","#bpbm-video-call .bpbm-video-call",function(e){var s=BPBMJQ(this).data("user-id");-1===X.indexOf(s.toString())&&(e.preventDefault(),e.stopImmediatePropagation(),BBPMShowError(BP_Messages.strings.call_offline))}),BPBMJQ(document).on("click",".bp-messages-wrap .bp-messages-call-controls .bpbm-switch-full-screen",function(e){if(e.preventDefault(),e.stopImmediatePropagation(),!1!==j){var s=BPBMJQ(this).closest(".bp-messages-video-container"),a=BPBMJQ('<div class="bp-messages-wrap bp-messages-full-screen-call"></div>').appendTo(BPBMJQ("body"));s.appendTo(a),J()}}),BPBMJQ(document).on("click",".bp-messages-wrap .bp-messages-call-controls .bpbm-switch-camera-video",function(e){if(e.preventDefault(),e.stopImmediatePropagation(),!1!==j){var s=BPBMJQ(this);j.getTracks().forEach(function(e){e.stop()}),F=!F,B(function(e,a,t){if(!1!==t){console.error(t);var i=t.toString().split(":");BBPMShowError(BP_Messages.strings.cam_not_works+": "+i[1])}else{var n=s.closest(".bp-messages-video-container");j=e,E=a;n.find(".bp-messages-placeholder-video").is(":visible")?(a.controls=!1,a.autoplay=!0,a.muted=!0,a.playsinline=!0,j.getAudioTracks()[0].enabled=!1,n.find(".bp-messages-placeholder-video").html(a),a.play()):p(j),BPBMJQ.each(S.getSenders(),function(s,a){var t=e.getTracks().find(function(e){return e.kind===a.track.kind});a.replaceTrack(t)})}})}}),BPBMJQ(document).on("click",".bp-messages-call-controls .bpbm-disable-video",function(e){e.preventDefault(),j.getVideoTracks()[0].enabled=!1,BPBMJQ(".bp-messages-call-controls .bpbm-disable-video").hide(),BPBMJQ(".bp-messages-call-controls .bpbm-enable-video").show()}),BPBMJQ(document).on("click",".bp-messages-call-controls .bpbm-enable-video",function(e){e.preventDefault(),j.getVideoTracks()[0].enabled=!0,BPBMJQ(".bp-messages-call-controls .bpbm-enable-video").hide(),BPBMJQ(".bp-messages-call-controls .bpbm-disable-video").show()}),BPBMJQ(document).on("click",".bp-messages-call-controls .bpbm-disable-mic",function(e){e.preventDefault(),j.getAudioTracks()[0].enabled=!1,BPBMJQ(".bp-messages-call-controls .bpbm-disable-mic").hide(),BPBMJQ(".bp-messages-call-controls .bpbm-enable-mic").show()}),BPBMJQ(document).on("click",".bp-messages-call-controls .bpbm-enable-mic",function(e){e.preventDefault(),j.getAudioTracks()[0].enabled=!0,BPBMJQ(".bp-messages-call-controls .bpbm-enable-mic").hide(),BPBMJQ(".bp-messages-call-controls .bpbm-disable-mic").show()}),BPBMJQ(document).on("click",".bp-messages-video-container .bp-messages-call-controls .bpbm-answer",function(s){if(s.preventDefault(),void 0===navigator.mediaDevices)BBPMShowError(BP_Messages.strings.no_webrtc);else{d();var a=BPBMJQ(this).data("user-id");S.participant=a,void 0!==$[a]&&clearTimeout($[a]),W.emit("mediaEvent",{event:"answered",to:a}),W.emit("mediaEvent",{event:"self_reject",to:BP_Messages.user_id}),H[a]="1",setTimeout(function(){delete H[a]},3e3),r();var t=e(".bp-messages-video-container"),i=t.closest(".bp-messages-wrap");i.find(".bp-messages-main-placeholder").hide(),i.find(".bp-messages-main-placeholder .bp-messages-placeholder-video").html(""),i.find(".bp-messages-main-video").show(),t.find(".bp-messages-call-controls > *").hide(),t.find(".bp-messages-call-controls").show(),t.find(".bp-messages-call-controls > .bpbm-call-in-progress").show(),p(j),"function"==typeof S.addTrack&&(j.getTracks().forEach(function(e){S.addTrack(e,j)}),S.peers[a]=S.createOffer(Y).then(function(e){S.setLocalDescription(e).then(function(){W.emit("mediaEvent",{event:"offer",to:a,sdp:e})})}).catch(function(e){console.error(e)}))}}),BPBMJQ(document).on("click",".bp-messages-audio-container .bp-messages-call-controls .bpbm-answer",function(s){if(s.preventDefault(),void 0===navigator.mediaDevices)BBPMShowError(BP_Messages.strings.no_webrtc);else{d();var a=BPBMJQ(this).data("user-id");S.participant=a,void 0!==$[a]&&clearTimeout($[a]),W.emit("mediaEvent",{event:"answered_call",to:a}),W.emit("mediaEvent",{event:"self_reject",to:BP_Messages.user_id}),H[a]="1",setTimeout(function(){delete H[a]},3e3),r();var t=e(".bp-messages-audio-container"),i=t.closest(".bp-messages-wrap");i.find(".bp-messages-placeholder-incoming-text, .bp-messages-placeholder-outgoing-text").hide();var n=i.find(".bp-messages-timer");n.show(),n.runner({format:function(e){return O(e)},milliseconds:!1}),n.runner("start"),t.find(".bp-messages-call-controls > *").hide(),t.find(".bp-messages-call-controls").show(),t.find(".bp-messages-call-controls > .bpbm-call-in-progress").show(),"function"==typeof S.addTrack&&(j.getTracks().forEach(function(e){S.addTrack(e,j)}),S.peers[a]=S.createOffer(Y).then(function(e){S.setLocalDescription(e).then(function(){W.emit("mediaEvent",{event:"offer",to:a,sdp:e})})}).catch(function(e){console.error(e)}))}}),BPBMJQ(document).on("click",".bp-messages-call-controls .bpbm-reject",function(e){e.preventDefault();var s=BPBMJQ(this).data("user-id");r(),W.emit("mediaEvent",{event:"rejected",to:s}),W.emit("mediaEvent",{event:"self_reject",to:BP_Messages.user_id}),H[s]="1",setTimeout(function(){delete H[s]},3e3),a()}),BPBMJQ(document).on("click",".bp-messages-video-container .bp-messages-call-controls .bpbm-cancel",function(s){s.preventDefault();var t=e(this);t.addClass("bpbm-blocked");var i=t.closest(".bp-messages-video-container");W.emit("mediaEvent",{event:"call_cancelled",to:S.participant,thread_id:i.data("thread-id")}),g(),a()}),BPBMJQ(document).on("click",".bp-messages-audio-container .bp-messages-call-controls .bpbm-cancel",function(s){s.preventDefault();var t=e(this);t.addClass("bpbm-blocked");var i=t.closest(".bp-messages-audio-container");W.emit("mediaEvent",{event:"call_cancelled",to:S.participant,thread_id:i.data("thread-id")}),g(),a()}),BPBMJQ(document).on("click",".bp-messages-video-container .bp-messages-call-controls .bpbm-call-end",function(e){e.preventDefault(),W.emit("mediaEvent",{event:"call_end",to:S.participant}),a()}),BPBMJQ(document).on("click",".bp-messages-audio-container .bp-messages-call-controls .bpbm-call-end",function(e){e.preventDefault(),W.emit("mediaEvent",{event:"call_end",to:S.participant}),a()}),BPBMJQ(document).on("click",".bp-messages-wrap.bp-messages-popup .bpbm-answer",function(s){s.preventDefault();var a=BPBMJQ(this).data("thread-id"),t=BP_Messages.threadUrl+a+"&acceptCall",i=e(".bp-messages-wrap.bp-messages-wrap-main");i.length>0?P(t,i):location.href=t,e(this).closest(".amaran.incoming_call").remove()}),BPBMJQ(document).on("click",".bp-messages-wrap.bp-messages-popup .bpbm-reject",function(s){s.preventDefault();var t=BPBMJQ(this).data("user-id");e(this).closest(".amaran.incoming_call").remove(),r(),W.emit("mediaEvent",{event:"rejected",to:t}),W.emit("mediaEvent",{event:"self_reject",to:BP_Messages.user_id}),H[t]="1",setTimeout(function(){delete H[t]},3e3),a()}),W.on("getUnread",function(a){var t=e('.bp-better-messages-list > .tabs > div[data-tab="messages"]'),i=0,n=0,r=e(".bp-messages-wrap .threads-list").length;Object.keys(a.threads).length>0?(e.each(a.threads,function(s){D(s,this),V[s]=this,i+=parseInt(this),n++,r>0&&0===e(de+'[data-id="'+s+'"]').length&&W.emit("threadOpen",s)}),r>0&&e(de+"[data-id]").each(function(){var s=e(this).data("id");void 0===a.threads[s]&&D(s,0)})):(i=0,e(".threads-list .thread, .bp-better-messages-mini .chat").removeClass("unread"),e(".threads-list .thread .time .unread-count").text(""),e(".bp-better-messages-mini .chat .unread-count").attr("class","unread-count count-0").text(""),V={}),i>0?(t.find(".fas").hide(),t.find(".unread-count").text(i).show()):(t.find(".fas").show(),t.find(".unread-count").text("").hide()),s(n)}),W.on("message_deleted",function(e){n([e])}),W.on("onlineUsers",function(e){Z=!0,X=e,M()}),W.on("userOnline",function(s){-1===X.indexOf(s)&&(X.push(s),e('.bbpm-avatar[data-user-id="'+s+'"]').addClass("online"),k())}),W.on("userOffline",function(s){X.indexOf(s)>-1&&(X.splice(X.indexOf(s),1),e('.bbpm-avatar[data-user-id="'+s+'"]').removeClass("online"),k())}),W.on("message",function(s){var a='.bp-better-messages-mini .chats .chat[data-thread="'+s.thread_id+'"]',t=e(a),i=e('.bp-better-messages-mini .chats .chat[data-thread="'+s.thread_id+'"].open'),n=s.thread_id;if("1"===BP_Messages.encryption){var r=e('.bp-messages-wrap .thread.scroller[data-id="'+n+'"][data-secret]'),o=r.data("secret"),l=BP_Messages.encrypt_key;if(s.fast&&r.length>0){var c=BPBMAES256.decrypt(s.message,o);c=BPBMJQ("<div />").text(c).html();["p","b","i","u","strike","sub","sup","br"].forEach(function(e,s){var a=new RegExp("&lt;"+e+"&gt;","g"),t=new RegExp("&lt;/"+e+"&gt;","g");c=c.replace(a,"<"+e+">",c),c=c.replace(t,"</"+e+">",c)}),c=c.replace(/ style=\"\"/g,"",c),c=c.replace(/<br>/g,"\n",c),c=c.replace(/&nbsp;/g," ",c),c=c.replace(/&amp;nbsp;/g," ",c),"<p>"===(c=c.trim()).substring(0,3)&&(c=c.substring(3)),"</p>"===c.substring(c.length-4)&&(c=c.substring(0,c.length-4)),c=c.replace(/&amp;lt;/g,"&lt;",c),c=c.replace(/&amp;gt;/g,"&gt;",c),c=c.replace(/\n/g,"<br>",c),c=emojione.toImage(c),s.message=c}else s.fast||(void 0!==s.content_site&&(s.content_site=BPBMAES256.decrypt(s.content_site,l)),void 0!==s.html&&(s.html=BPBMAES256.decrypt(s.html,l)),s.avatar=BPBMAES256.decrypt(s.avatar,l),s.name=BPBMAES256.decrypt(s.name,l),r.length>0&&(s.message=BPBMAES256.decrypt(s.message,o),s.link=BPBMAES256.decrypt(s.link,o)))}if(s.fast){var d=e('.bp-messages-wrap .thread.scroller[data-id="'+n+'"][data-users-json]');if(d.length>0){var p=atob(d.attr("data-users-json")),m=e.parseJSON(p);if(void 0===m[s.user_id])return!1;s.avatar=m[s.user_id].avatar,s.link=m[s.user_id].link,s.name=m[s.user_id].name}}if(!s.fast&&"1"==BP_Messages.realtime){if(BP_Messages.user_id!=s.user_id){var g=!1,h=parseInt(s.thread_id)===parseInt(N);e("body").hasClass("bp-messages-mobile")?h&&(g=!0):be||ifvisible.now("active")&&(h&&(g=!0),i.length>0&&(g=!0)),g?(W.emit("seen",[s.id]),W.emit("threadOpen",s.thread_id),U("bp-better-messages-thread-"+s.thread_id,s.timestamp,1)):W.emit("delivered",s.id)}else U("bp-better-messages-thread-"+s.thread_id,s.timestamp,1);var b=s.id,u=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+b+'"]');u.length>0&&u.find(".message-content").html(s.message)}y(s),N==s.thread_id?C(s):R?t.length>0&&C(s,a):t.length>0?C(s,a):void 0===s.content_site||BP_Messages.user_id==s.user_id||s.fast||x(s.thread_id,s.content_site,s.name,s.avatar)}),"1"==BP_Messages.realtime&&(W.on("delivered",function(s,a){var t=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');t.removeClass("sent"),t.addClass("delivered"),t.find(".status").attr("title",BP_Messages.strings.delivered),c(t)}),W.on("seen",function(s,a){var t=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');t.removeClass("delivered sent"),t.addClass("seen"),t.find(".status").attr("title",BP_Messages.strings.seen),c(t)})),W.on("writing",function(s){if("object"==typeof s){var a={};e.each(s,function(s){void 0===a[s]&&(a[s]=[]);var t=e('.bp-messages-wrap .thread[data-id="'+s+'"][data-users-json');if(t.length>0){var i=t.attr("data-users-json"),n=e.parseJSON(atob(i));"object"==typeof n&&void 0!==n[this]&&a[s].push(n[this].name)}}),e.each(a,function(s){e(de+'[data-id="'+s+'"]');if(this.length>0){Q();var a=e('.bp-messages-wrap .thread[data-id="'+s+'"]').parents(".bp-messages-wrap");if(a.hasClass("bp-better-messages-mini"))t=a.find('.chat[data-thread="'+s+'"] span.writing');else var t=a.find("span.writing");t.attr("data-time",Date.now()),t.addClass("shown"),t.html(this.join(", ")+" "+BP_Messages.strings.writing),t.show()}}),e.each(a,function(s){var a=e(de+'[data-id="'+s+'"]');if(a.length>0){var t=a.find(".info p"),i=t.html();void 0===t.attr("writing-reserved")&&t.attr("writing-reserved",i),t.attr("writing-time",Date.now()),a.addClass("bpbm-writing"),t.html('<span class="bpbm-typing">'+BP_Messages.strings.writing+"</span>")}})}}),setInterval(function(){var s=e("span.writing.shown");s.length>0&&s.each(function(){parseInt(e(this).attr("data-time"))+3e3<Date.now()&&e(this).hide().removeClass("shown")});var a=e(de+".bpbm-writing");a.length>0&&a.each(function(){var s=e(this),a=s.find(".info p");if(parseInt(a.attr("writing-time"))+3e3<Date.now()){var t=a.attr("writing-reserved");a.removeAttr("writing-reserved"),a.removeAttr("writing-time"),a.html(t),s.removeClass("bpbm-writing")}})},1e3);var le={};e(document).on("keyup",".bp-messages-wrap .reply .bp-emojionearea-editor",function(s){var a=e(this).closest(".bp-messages-wrap"),t=a.attr("data-thread-id");t||(t=a.find(".thread[data-id]").data("id")),void 0===le[t]&&(le[t]=0),s.which<=90&&s.which>=48&&(ifvisible.focus(),(0===le[t]||le[t]+1e3<Date.now())&&(le[t]=Date.now(),W.emit("writing",t,a.find(".thread[data-users]").attr("data-users"))))}),e(document).on("pointermove",".bp-messages-wrap .reply",function(e){e.stopImmediatePropagation()}),e(document).on("pointerover",".bp-messages-wrap .reply",function(e){e.stopImmediatePropagation()}),e(document).on("keyup",".bp-messages-wrap .reply textarea",function(s){var a=e(this).closest(".bp-messages-wrap"),t=a.find(".thread[data-id]").data("id");void 0===le[t]&&(le[t]=0),s.which<=90&&s.which>=48&&(0===le[t]||le[t]+1e3<Date.now())&&(le[t]=Date.now(),W.emit("writing",t,a.find(".thread[data-users]").attr("data-users")))}),"1"==BP_Messages.realtime&&(ifvisible.on("wakeup",T),e(document).on("bp-better-messages-mobile-open",T))}function l(s){var a=[];return e.each(s,function(s,t){-1===e.inArray(t,a)&&a.push(t)}),a}function c(s){if("1"===BP_Messages.messagesStatus){if((s=e(s)).hasClass("my")){var a=s.find(".status");s.hasClass("seen")?a.html(me.seen):s.hasClass("delivered")?a.html(me.delivered):a.html(me.sent)}p(s)}}function d(){function a(s){function a(){if(!0===i)return!1;if(t.next(".bp-emojionearea").length>0){i=!0,r();new BPBM_MediumEditor(".bp-emojionearea-editor",{toolbar:{allowMultiParagraphSelection:!1,buttons:["bold","italic","underline","strikethrough","subscript","superscript","removeFormat"],diffLeft:0,diffTop:-10,firstButtonClass:"medium-editor-button-first",lastButtonClass:"medium-editor-button-last",relativeContainer:null,standardizeSelectionStart:!1,static:!1,align:"center",sticky:!1,updateOnEmptySelection:!0},placeholder:!1,imageDragging:!1}),e(t).html("<p></p>")}else setTimeout(a,333)}var t=e(s).BPemojioneArea({tones:!0,tonesStyle:"bullet",saveEmojisAs:"unicode",autocomplete:!1,stayFocused:!1,attributes:{dir:o}});if(void 0!==t[0]){t.closest("form").addClass("bp-emoji-enabled");var i=!1;try{t[0].BPemojioneArea.on("onLoad",function(){a()})}catch(e){}setTimeout(a,333)}}function i(s,a){void 0===a&&(a=!1);var t=e(s);if(t.hasClass("loading-more")||t.hasClass("all-loaded"))return!1;t.addClass("loading-more"),t.find(".loading-messages").show();var n=[],r=t.find(".loading-messages");t.find(".threads-list > .thread").each(function(){n.push(e(this).data("id"))});var o={action:"bp_messages_get_more_threads",loaded_threads:n,user_id:BP_Messages.displayed_user_id};t.closest(".bp-messages-wrap").hasClass("bp-better-messages-list")&&(o.user_id=BP_Messages.user_id),e.post(BP_Messages.ajaxUrl,o,function(n){e(n).insertBefore(r),t.removeClass("loading-more"),t.find(".loading-messages").hide(),""===n.trim()?t.addClass("all-loaded"):a&&Math.ceil(s.get(0).scrollHeight)<=Math.ceil(s.innerHeight())&&i(s,!0)})}N=!1,R=!1,K=!0,clearTimeout(H),"1"!==BP_Messages.realtime&&s(BP_Messages.total_unread),document.dispatchEvent(new Event("bp-better-messages-reinit-start")),w(),M(),e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?N=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container) .threads-list").length>0&&(R=!0),H=N?setTimeout(B,BP_Messages.threadRefresh):setTimeout(_,BP_Messages.siteRefresh),"1"==BP_Messages.miniChats&&e.each(Y,function(s){s!==N?S(s,this):e('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+N+'"]').remove()}),!1!==q?(e('.bp-better-messages-list .tabs > div[data-tab="'+q+'"]').addClass("active"),e(".bp-better-messages-list .tabs-content ."+q).addClass("active"),e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').show()):e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').hide();var o="ltr";se&&(o="rtl");if("1"===BP_Messages.mobileEmojiEnable||!be&&!e("body").hasClass("bp-messages-mobile")){a(d=".bp-messages-wrap .reply .message textarea, .bp-messages-wrap .new-message #message-input, .bp-messages-wrap .bulk-message #message-input")}else{var d=".bp-better-messages-mini .chats .chat .reply .message textarea";a(d),e.fn.BPBMloadEmojione(123),r()}if("function"==typeof e.fn.BPBMoverlayScrollbars){BPBMJQ(".bp-better-messages-list .tabs-content .friends .scroller,.bp-better-messages-list .tabs-content .bpbm-groups .scroller,.scroller.search, .scroller.starred").BPBMoverlayScrollbars({sizeAutoCapable:!1,overflowBehavior:{x:"hidden"}}),BPBMJQ(".bpbm-stickers-selector .bpbm-stickers-head .bpbm-stickers-tabs").BPBMoverlayScrollbars({sizeAutoCapable:!1,overflowBehavior:{y:"hidden"}});var b=!1;BPBMJQ(".scroller.thread").BPBMoverlayScrollbars({sizeAutoCapable:!0,autoUpdate:!0,overflowBehavior:{x:"hidden"},callbacks:{onInitialized:function(){var s=this.getElements(),a=this.scroll().max.y,t=!1;if(L("message_id").length>0){var i=L("message_id"),n=e(s.content).find(".messages-list li[data-id='"+i+"']");n.length>0&&(t=n)}!1!==t?(BPBMJQ(this.getElements().host).addClass("user-scrolled"),this.scroll({el:t,scroll:"ifneeded",margin:20})):BPBMJQ(s.host).is(":visible")&&0===a?f(this,!0):this.scroll({y:"100%"})},onScroll:function(e){var s=this,a=this.scroll(),t=a.position.y,i=a.max.y;0===i?f(this,!0):0===t?f(this):t>=i&&setTimeout(function(){t=a.position.y,i=a.max.y,t>=i&&BPBMJQ(s.getElements().host).removeClass("user-scrolled")},300)},onContentSizeChanged:function(e){var s=this.getElements(),a=this.scroll(),t=a.max.y,i=a.position.y,n=BPBMJQ(s.host),r=BPBMJQ(s.content).find(".list .messages-stack:last .content .messages-list li:last").outerHeight();r<100&&(r=100);var o=this;(!n.hasClass("user-scrolled")||t-i<r+50)&&(ue||(b=!0,o.scroll({y:"100%"},100,void 0,function(){b=!1}))),setTimeout(function(){n.hasClass("user-scrolled")||ue||(b=!0,o.scroll({y:"100%"},100,void 0,function(){b=!1}))},100)},onHostSizeChanged:function(){var s=this,a=this.scroll(),t=a.position.y,i=a.max.y;BPBMJQ(s.getElements().host).hasClass("user-scrolled")||e("body").hasClass("bpbm-os-dragging")?t>=i&&setTimeout(function(){t=a.position.y,i=a.max.y,t>=i&&BPBMJQ(s.getElements().host).removeClass("user-scrolled")},300):this.scroll({y:"100%"},0)}}}),BPBMJQ(".scroller.threads-list-wrapper").BPBMoverlayScrollbars({sizeAutoCapable:!1,overflowBehavior:{x:"hidden"},callbacks:{onInitialized:function(){},onScroll:function(e){var s=this.getElements(),a=this.scroll(),t=a.position.y,n=a.max.y,r=BPBMJQ(s.host);n-t<=100&&i(r)},onContentSizeChanged:function(e){}}})}if(BPBMJQ(".scrollbar-inner").on("touchstart click mousewheel DOMMouseScroll",function(e){0===BPBMJQ(e.target).closest(".bpbm-reply").length&&BPBMJQ(this).addClass("user-scrolled")}),t(),"1"==BP_Messages.realtime){var v=[],P=[];e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .list .messages-stack .content .messages-list li:not(.seen), .bp-messages-wrap.bp-better-messages-mini .chat.open .list .messages-stack .content .messages-list li:not(.seen)").each(function(){var s=e(this).data("id"),a=e(this).data("thread");v.push(s),P.push(a)}),W.emit("getStatuses",v,function(s){var a={};e.each(v,function(){a[this]=!0}),e.each(s,function(s){delete a[s];var t=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');if(t.removeClass("sent delivered seen"),t.hasClass("my")||t.hasClass("fast")){var i="sent";e.each(this,function(){if("seen"==i)return!1;"delivered"==this&&"seen"!=i&&(i="delivered"),"seen"==this&&(i="seen")}),t.addClass(i);var n="";switch(i){case"sent":n=BP_Messages.strings.sent;break;case"delivered":n=BP_Messages.strings.delivered;break;case"seen":n=BP_Messages.strings.seen}t.find(".status").attr("title",n),c(t)}else"seen"!==this.toString()&&W.emit("seen",[s])}),e.each(a,function(s){var a=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');a.removeClass("sent delivered seen"),a.addClass("seen"),a.find(".status").attr("title",BP_Messages.strings.seen),c(a)})}),N&&W.emit("threadOpen",N),P=l(P),e.each(P,function(e,s){void 0!==s&&W.emit("threadOpen",s)}),W.emit("requestUnread")}if(r(),e(window).on("resize",function(){r()}),e(".bp-messages-wrap #send-to:not(.ready)").length>0){var k=[],y=new Taggle("send-to",{placeholder:"",tabIndex:2,hiddenInputName:"recipients[]"}),C=y.getContainer(),x=y.getInput(),J=e('input[name="to"]');J.length>0&&(e(J).each(function(){var s=e(this).data("img"),a=e(this).data("label");y.add(e(this).val()),e(C).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar"><img src="'+s+'" class="avatar photo" width="50" height="50"></span><span class="bpbm-name">'+a+"</span>"),e(this).remove()}),e("#send-to").removeClass("active"),e("#send-to input").css("width","10px")),e(x).on("blur",function(s){var a=e(C).find(".taggle_sizer").text();y.add(a)}),"0"===BP_Messages.disableUsersSearch&&(e(x).autocomplete({source:function(s,a){var t=s.term;t in k?a(k[t]):e.getJSON(BP_Messages.ajaxUrl+"?q="+t+"&limit=10&action=bp_messages_autocomplete&cookie="+function(){var e,s,a,t,i,n=document.cookie.split(";"),r={};for(e=0;e<n.length;e++)s=n[e],a=s.indexOf("="),t=BPBMJQ.trim(unescape(s.slice(0,a))),i=unescape(s.slice(a+1)),0===t.indexOf("bp-")&&(r[t]=i);return encodeURIComponent(BPBMJQ.param(r))}(),s,function(e,s,i){k[t]=e,a(e)})},minLength:2,appendTo:C,position:{at:"left bottom",of:C},open:function(s,a){var t=e(".bp-messages-wrap #send-to .ui-autocomplete"),i=parseInt(t.css("top"))-3;t.css("top",i)},select:function(s,a){s.preventDefault(),1===s.which&&(y.add(a.item.value),e(C).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar">'+a.item.img+'</span><span class="bpbm-name">'+a.item.label+"</span>"))},response:function(s,a){e(".ui-helper-hidden-accessible").hide()}}).autocomplete("instance")._renderItem=function(s,a){return e("<li>").attr("data-value",a.value).attr("data-label",a.label).append('<span class="bpbm-avatar">'+a.img+'</span><span class="bpbm-name">'+a.label+"</span>").appendTo(s)}),e("#send-to").addClass("ready")}$.find(".bp-messages-mobile-tap").css("line-height",$.height()+"px"),e(".bp-messages-side-threads .threads-list .thread.bp-messages-active-thread").removeClass("bp-messages-active-thread"),N&&e('.bp-messages-side-threads .threads-list .thread[data-id="'+N+'"]').addClass("bp-messages-active-thread");var T={},j={},D={show:function(e){e.$trigger.closest("li").addClass("selected")},hide:function(e){e.$trigger.closest("li").removeClass("selected")}};T.copy={name:BP_Messages.strings.copy_text,icon:"fas fa-copy",callback:function(e,s){var a=s.$trigger,t=a.find(".bpbm-replied-message-reply");h(t.length>0?t.text():a.text())}},j.copy={name:BP_Messages.strings.copy_text,icon:"fas fa-copy",callback:function(e,s){var a=s.$trigger,t=a.find(".bpbm-replied-message-reply");h(t.length>0?t.text():a.text())}},"1"===BP_Messages.allowEditMessages&&(T.edit={name:BP_Messages.strings.edit,icon:"fas fa-pen",callback:function(s,a){var t=a.$trigger,i=BP_Messages.editNonce,n=t.closest("li"),r=n.closest(".messages-stack").closest(".bp-messages-threads-wrapper"),o=n.attr("data-id"),l="",c="",d=n.find(".bpbm-replied-message-reply");d.length>0?l+=d.text():l+=n.find(".message-content").text();var p=n.find(".message-content > [data-desc]");p.length>0&&p.each(function(){var s=e(this).attr("data-desc");void 0!==s&&(c+='<span class="bpbm-preview-desc">'+atob(s)+"</span>")});var m='<div class="bpbm-preview-message bpbm-edit-message" style="display:none" data-message-id="'+o+'"><div class="bpbm-preview-message-cancel"><i class="far fa-times-circle"></i></div><div class="bpbm-preview-message-content"><span class="bpbm-preview-message-name">'+BP_Messages.strings.edit_message+'</span><div class="bpbm-preview-message-text"></div></div></div>',g=r.find(".bpbm-preview-message");g.length>0?(g=g.replaceWith(m),(g=r.find(".bpbm-preview-message")).show(),Q()):(g=e(m).insertBefore(r.find(".reply"))).slideDown(100,function(){Q()}),g.find(".bpbm-preview-message-text").text(l),g.find(".bpbm-preview-message-text").append(c),g.find(".bpbm-gifs-icon").html(ge.gif),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_get_edit_message",message_id:o,_wpnonce:i},function(e){if(void 0!==e.errors)BBPMShowError(e.errors[0]),g.find(".bpbm-preview-message-cancel").click();else{var s=r.find(".bp-emojionearea-editor");s.length>0?s.html(emojione.toImage(e)):r.find(".reply .message textarea").html(e)}})},visible:function(e,s){return s.$trigger.closest(".bp-messages-threads-wrapper").find(".reply").length>0}});var E={name:BP_Messages.strings.delete,icon:"fas fa-trash",callback:function(s,a){var t=a.$trigger,i=BP_Messages.editNonce,r=BP_Messages.strings.confirm_delete,o=t.closest("li");if(confirm(r)){var l=[o.attr("data-id")],c=o.attr("data-thread");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_message",thread_id:c,messages_ids:l,_wpnonce:i},function(e){e.result?(BBPMNotice(e.message),n(l)):BBPMShowError(e.errors[0])})}},visible:function(e,s){return s.$trigger.closest(".bp-messages-threads-wrapper").find(".reply").length>0&&(!("1"!==BP_Messages.allowDeleteMessages||!s.$trigger.closest(".messages-stack").hasClass("outgoing"))||!!s.$trigger.closest(".list").hasClass("can-moderate"))}};"1"===BP_Messages.enableReplies&&(j.reply={name:BP_Messages.strings.reply,icon:"fas fa-reply",callback:function(e,s){s.$trigger.closest("li").find(".bpbm-reply").click()},visible:function(e,s){return s.$trigger.closest(".bp-messages-threads-wrapper").find(".reply").length>0}}),T.delete=E,j.delete=E,e.BPBMcontextMenu({selector:ce,events:D,items:T,autoHide:!1,zIndex:10,position:function(e,s,a){var t=window.innerWidth-e.$menu.width()-100;s>t&&(s=t),e.$menu.css({left:s,top:a})}}),e.BPBMcontextMenu({selector:le,events:D,items:j,autoHide:!1,zIndex:10,position:function(e,s,a){var t=window.innerWidth-e.$menu.width()-100;s>t&&(s=t),e.$menu.css({left:s,top:a})}});var U={};U.open={name:BP_Messages.strings.open,icon:"fas fa-external-link-square-alt",callback:function(e,s){s.$trigger.closest(".thread").click()}},U.delete={name:BP_Messages.strings.delete,icon:"fas fa-trash",callback:function(e,s){s.$trigger.closest(".thread").find("span.delete").click()},visible:function(e,s){return s.$trigger.closest(".thread").find("span.delete").length>0}},e.BPBMcontextMenu({selector:de,events:D,items:U,autoHide:!1,zIndex:10,position:function(e,s,a){var t=window.innerWidth-e.$menu.width()-100;s>t&&(s=t),e.$menu.css({left:s,top:a})}}),g(),"1"===BP_Messages.enablePushNotifications&&e(".BPBMpushNotifications").length>0&&BPBMcheckPushWorkerStatus(),"1"===BP_Messages.messagesStatus&&e(".bp-messages-wrap .list .messages-stack .content .messages-list li").each(function(){c(this)}),A($),e(".bpbm-gifs-icon").html(ge.gif),m(),function(){if(ve)return!1;ve=!0,u()}(),p(),document.dispatchEvent(new Event("bp-better-messages-reinit-end")),K=!1}function p(e){void 0===e&&(e=BPBMJQ(".bp-messages-wrap")),be||e.find(".status[title], .bpbm-reply[title], .chat-header [title], .chat-footer [title], .threads-list [title], .chats .chat .head .controls [title]").each(function(){var e=BPBMJQ(this);e.is("strong")||e.is("input")||(void 0!==e[0]._tippy&&e[0]._tippy.destroy(),bpbmtippy(e[0],{placement:"top",content:e.attr("title"),arrow:!1,offset:[0,5]}),e[0].removeAttribute("title"))})}function m(){e(".bp-messages-iframe-container").each(function(){e(this).closest(".message-content").addClass("has-iframe")})}function g(){be&&(e(le).BPBMswipe("destroy"),e(le).BPBMswipe({longTap:function(s,a){e(this).contextMenu({x:s.changedTouches[0].screenX,y:s.changedTouches[0].screenY})}}),e(ce).BPBMswipe("destroy"),e(ce).BPBMswipe({longTap:function(s,a){e(this).contextMenu({x:s.changedTouches[0].screenX,y:s.changedTouches[0].screenY})}}),e(de).BPBMswipe("destroy"),e(de).BPBMswipe({longTap:function(s,a){e(this).contextMenu({x:s.changedTouches[0].screenX,y:s.changedTouches[0].screenY})}}))}function h(s){var a=e("<input>");e("body").append(a),a.val(s).select(),document.execCommand("copy"),a.remove()}function b(s){s=e(s);if(be)i(s);else{var a=80+parseInt(BP_Messages.fixedHeaderHeight);e("html, body").animate({scrollTop:s.offset().top-a},500)}}function u(){if(void 0===W)return!1;if(W.connected){var s=window.location.search,a=new URLSearchParams(s),t=a.get("videoCall"),i=a.get("audioCall"),n=a.get("acceptCall"),r=a.get("scrollToContainer"),o=e(".bp-messages-wrap.bp-messages-wrap-main");if(o.length>0){var l=!1;"string"==typeof t?(o.find(".chat-header .video-call").click(),b(o),l=!0):"string"==typeof i?(o.find(".chat-header .audio-call").click(),b(o),l=!0):"string"==typeof n?(b(o),l=!0):"string"==typeof r&&(b(o),l=!0),l&&(a.delete("videoCall"),a.delete("audioCall"),a.delete("acceptCall"),a.delete("scrollToContainer"),window.history.pushState("","","?"+a.toString()))}setTimeout(function(){ve=!1},1e3)}else setTimeout(u,500)}function f(s,a){void 0===a&&(a=!1);var t=s.getElements(),i=BPBMJQ(t.host);if(i.hasClass("loadingAtTheMoment")||i.hasClass("allMessagesWasLoaded"))return!1;var n=i.data("id");i.find(".loading-messages").show(),i.addClass("loadingAtTheMoment");var r=i.find(".messages-stack:first-child .messages-list li:first-child"),o=r.attr("data-id");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_load_messages",thread_id:n,message_id:o},function(t){i.find(".loading-messages").hide(),""===t.trim()&&i.addClass("allMessagesWasLoaded"),e(t).prependTo(i.find(".list")),i.addClass("hasLoadedMessages"),s.scroll({el:r.closest(".messages-stack"),margin:15}),d(),i.removeClass("loadingAtTheMoment"),a&&0===s.scroll().max.y&&f(s,!0)})}function v(s){if(void 0===s&&(s=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)"),0!=e(s+" .list").length){var a=e(s+" .scroller[data-id]"),t=a.data("id");if(void 0!==G[t])return!1;var i=e(s+" .list"),n=i[0].offsetHeight;if(L("message_id").length>0){var r=L("message_id"),o=e(s+" .messages-list li[data-id='"+r+"']");o.length>0&&(n=o[0].offsetTop-o[0].offsetHeight-100)}var l=i.closest(".scroller"),c=l.hasClass("user-scrolled"),d=l[0].scrollHeight-l.scrollTop()-l.height();if(!(n<l.outerHeight())&&(!c||100>=d)){var p=a.BPBMoverlayScrollbars();void 0!==p&&(p.update(),p.scroll({y:"100%"}))}}}function _(){if(clearInterval(H),H=setTimeout(_,BP_Messages.siteRefresh),"1"!=BP_Messages.realtime&&!_e){var a=I("bp-messages-last-check");_e=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_check_new",last_check:a},function(a){a.threads.length>0&&e.each(a.threads,function(){void 0!==this.avatar&&(this.avatar=this.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")),R?y(this):x(this.thread_id,this.message,this.name,this.avatar)}),s(a.total_unread),_e=!1})}}function B(){if(clearInterval(H),H=setTimeout(B,BP_Messages.threadRefresh),"1"!=BP_Messages.realtime&&!Be){var a=I("bp-messages-last-check"),t=e(".messages-stack:last-child .messages-list li:last-child").attr("data-time");Be=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_check_new",last_check:a,thread_id:N,last_message:t},function(a){e.each(a.messages,function(){"string"==typeof this.avatar&&(this.avatar=this.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")),C(this)}),e.each(a.threads,function(){"string"==typeof this.avatar&&(this.avatar=this.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")),x(this.thread_id,this.message,this.name,this.avatar)}),s(a.total_unread),Be=!1})}}function w(){if(!store.enabled)return!1;F=store.get("bp-better-messages-open-threads")||{},!1!==N&&(F[N]=Date.now()),e.each(F,function(e){this+2e3<Date.now()&&delete F[e]}),store.set("bp-better-messages-open-threads",F)}function P(a,t){if(void 0===t){var i=BPBMJQ(event.target);t=i.hasClass("bp-messages-wrap")?i:i.closest(".bp-messages-wrap")}if(ie){if(!1===confirm(BP_Messages.strings.you_are_in_call))return!1;BPBMJQ(document).trigger("bpbm-end-call")}if(t.hasClass("bp-messages-wrap-main")&&!t.hasClass("bp-messages-group-thread"))try{window.history.pushState("","",a)}catch(e){}z(t);var n=t.height();t.css("min-height",n),e(window).off(".bp-messages");var r="?action=bp_messages_load_via_ajax";void 0!==a.split("?")[1]&&(r="?"+a.split("?")[1]+"&action=bp_messages_load_via_ajax");var o=t.find(".bp-messages-side-threads"),l=BP_Messages.ajaxUrl+r;o.length>0&&(l+="&ignore_threads"),e(".bpbm-notice").remove(),e.ajax({method:"GET",url:l,dataType:"json",cache:!1,success:function(a){void 0!==a.total_unread&&s(a.total_unread);var i=a.html,n=e(i),r=n.find(".bp-messages-side-threads");o.length>0&&r.length>0?(t.find(".bp-messages-threads-wrapper .bp-messages-column").html(n.find(".bp-messages-threads-wrapper .bp-messages-column").html()),t.find(".bp-messages-threads-wrapper").closest(".bp-messages-wrap").find(".chat-header:not(.side-header)").html(n.find(".bp-messages-threads-wrapper").closest(".bp-messages-wrap").find(".chat-header:not(.side-header)").html())):t.html(e(n).html()),t.hasClass("bp-messages-wrap-main")&&(t.attr("data-thread-id",n.attr("data-thread-id")),void 0!==a.errors&&e(a.errors.join("")).insertBefore(t)),t.is("#bp-better-messages-mini-mobile-container")&&t.attr("data-thread",n.attr("data-thread-id")),d(),t.css("min-height","")}})}function M(){e(".bp-messages-wrap img.avatar[data-user-id]").each(function(){var s=e(this),a=s.attr("data-user-id"),t=s.attr("data-bpbm-status-color"),i=!1;if(s.parent().hasClass("bbpm-avatar")&&(i=s.parent()),!i){var n=s.height(),r=s.height(),o=s.css("marginTop"),l=s.css("marginLeft"),c=s.css("marginBottom"),d=s.css("marginRight");e(this).css({marginTop:0,marginLeft:0,marginRight:0,marginBottom:0});var p='<span class="avatar bbpm-avatar" data-user-id="'+a+'"';"0"!==BP_Messages.userStatus&&void 0!==t&&(p+='style="color:'+t+'"'),p+="></span>",s.wrap(p),(i=s.parent()).css({marginTop:o,marginLeft:l,marginRight:d,marginBottom:c,minWidth:n,minHeight:r})}X.indexOf(a)>-1?e(i).addClass("online"):e(i).removeClass("online")}),k()}function k(){var s=e(".bp-better-messages-list .tabs-content .friends");if(s.length>0){var a=s.find(".bp-messages-user-list");if(a.length>0){var t=[];a.find(" > .user").each(function(){var s=e(this),i=s.attr("data-id"),n=s.prev().hasClass("online");X.indexOf(i)>-1?(s.addClass("online"),n||s.prependTo(a)):(t.push(s),s.removeClass("online"))}),t.length>0&&e.each(t,function(){var s=e(this);s.next().hasClass("online")&&s.insertAfter(a.find(" > .user.online:last"))})}}}function y(s){if(void 0===s.html)return!1;if(s.fast||"1"==s.edit)return!1;e(".bp-messages-wrap .threads-list .empty").remove(),e(".bp-messages-wrap .bp-messages-threads-wrapper.no-threads").removeClass("no-threads");var a=s.thread_id,t=s.html;t=t.replace('loading="lazy"',"");var i=e(de+"[data-id='"+a+"']");if(i.length>0){var n=s.content_site;i.each(function(){var a=e(this),t=a.find(".info p"),i=a.closest(".threads-list");if(i.removeClass("empty"),t.html(n),void 0!==t.attr("writing-reserved")&&t.attr("writing-reserved",n),a.attr("data-message",s.id),a.prependTo(i),"1"===BP_Messages.realtime){var r=a.find(".time-wrapper"),o=parseInt(s.timestamp);r.livestamp(new Date(1e3*o))}else"1"!==BP_Messages.realtime&&void 0!==s.html&&a.replaceWith(s.html)})}else e(".bp-messages-wrap .threads-list").each(function(){0===e(this).closest(".bpbm-search-results-section").length&&(e(this).removeClass("empty"),e(t).prependTo(e(this)))});void 0===BP_Messages.mutedThreads[a]&&BP_Messages.user_id!=s.user_id&&(void 0!==s.count_unread?"0"!==s.count_unread&&E(s.id):E(s.id)),M()}function C(s,a){if("string"==typeof BP_Messages.fast&&s.fast&&"1"!==BP_Messages.fast)return!1;var i=!1,n=!1;if(void 0===a&&(a=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)"),""==s.message.trim())return!1;var r,o="1"==s.edit;r="string"!=typeof s.avatar?"":'<div class="pic">'+s.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")+"</div>","1"!=BP_Messages.realtime||s.fast||(o?(i=!0,s.temp_id=s.id):s.temp_id&&(i=!0));var l=moment(x).format("YYYY-MM-DD HH:mm:ss").toString(),d=e(a+" .messages-stack:last-child"),h="standard";d.closest(".bp-messages-wrap").hasClass("bpbm-template-modern")&&(h="modern"),0===d.length&&e(a+" .empty-thread").length>0&&(n=!0);var b=e(a+' .messages-list li[data-id="'+s.id+'"]'),u="";e("body").hasClass("bp-messages-mobile")&&parseInt(s.thread_id)===parseInt(N)||ifvisible.now("active")||"1"!=BP_Messages.realtime||s.user_id===BP_Messages.user_id||(u+=" unread"),s.user_id==BP_Messages.user_id&&(u+=" my"),s.fast&&(u+=" fast"),s.user_id==BP_Messages.user_id&&"1"==BP_Messages.realtime&&(u+=" sent"),u=u.trim();var f=e(a+' .messages-list li[data-id="'+s.temp_id+'"]');o&&f.length>0&&(u=f.attr("class"));var v='<li class="'+u+'" data-thread="'+s.thread_id+'" title="'+l+'" data-time="'+s.timestamp+'" data-id="'+s.id+'">',_="",B="",w="",P="message-content";if("1"===BP_Messages.enableReplies&&(s.user_id!=BP_Messages.user_id&&(B='<span class="bpbm-reply" title="'+BP_Messages.strings.reply+'"><i class="fas fa-reply"></i></span>'),P+=" reply-enabled"),"1"===BP_Messages.messagesStatus&&s.user_id==BP_Messages.user_id&&(_+='<span class="status" title="'+BP_Messages.strings.sent+'"></span>'),"1"!==BP_Messages.disableFavoriteMessages&&(w+='<span class="favorite"><i class="fas" aria-hidden="true"></i></span>'),"standard"===h&&(v+=_,v+=w,v+=B),v+='<span class="'+P+'">',"modern"===h&&(v+=B,v+=_,v+=w),v+=s.message,v+="</span></li>",i&&f.length>0)return s.message!==f.find(".message-content").html()?(f.replaceWith(v),e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s.id+'"]').each(function(){c(this),p(BPBMJQ(this))})):(f.attr("data-id",s.id),f.removeClass("fast"),c(f)),g(),m(),!0;if(0===b.length&&(d.length>0||n)){1==n&&e(a+" .empty-thread").remove();var k=!0,y=new Date(1e3*d.find(".messages-list > li:last-child").attr("data-time")),C=y.getFullYear()+"-"+y.getMonth()+"-"+y.getDate()+"-"+y.getHours()+"-"+y.getMinutes(),x=new Date(1e3*s.timestamp),J=x.getFullYear()+"-"+x.getMonth()+"-"+x.getDate()+"-"+x.getHours()+"-"+x.getMinutes();if(d.attr("data-user-id")===s.user_id&&(k=!1),C!==J&&(k=!0),!1===k)d.find(".messages-list").append(v);else{var T="messages-stack";s.user_id==BP_Messages.user_id?T+=" outgoing":T+=" incoming";var S='<a href="'+s.link+'">'+s.name+"</a>";!1===s.link&&(S="<span>"+s.name+"</span>");var j='<div class="'+T+'" data-user-id="'+s.user_id+'">';j+=r,j+='<div class="content"><div class="info"><div class="name">'+S+'</div><div class="time" title="'+l+'" data-livestamp="'+s.timestamp+'"></div></div><ul class="messages-list"></ul></div></div>',e(a+" .list").append(j),e(a+" .messages-stack:last-child .messages-list").append(v)}s.fast&&e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s.id+'"]').each(function(){c(this)}),"function"==typeof e.fn.BPBMmagnificPopup&&e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").BPBMmagnificPopup({delegate:"a",type:"image"}),void 0===BP_Messages.mutedThreads[s.thread_id]&&BP_Messages.user_id!=s.user_id&&(void 0!==s.count_unread?"0"!==s.count_unread&&E(s.id):E(s.id))}var Q=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s.id+'"]');be||Q.find(".bpbm-gif").each(function(){var s=e(this);s.find(".bpbm-gif-play").remove();s.find("video")[0].play()}),e(".bpbm-gifs-icon").html(ge.gif),c(Q),t(),M(),g(),m(),p(Q),document.dispatchEvent(new Event("bp-better-messages-message-render-end"))}function x(s,a,t,i){if("1"!==BP_Messages.disableOnSiteNotification&&void 0===F[s]&&void 0===BP_Messages.mutedThreads[s]&&!e("body").hasClass("bp-messages-mobile")){if(e(de+'[data-id="'+s+'"]:visible').length>0)return!1;var n=i.match(/src\="([^\s]*)"\s/),r=i.match(/src\='([^\s]*)'\s/);null!=n&&(i=n[1]),null!=r&&(i=r[1]);var o=e(".amaran.thread_"+s);if(o.length>0){o.find(".icon > img").attr("src",i);var l="<b>"+t+"</b>";return l+=a,o.find(".info").html(l),!0}"1"==BP_Messages.miniMessages&&"messages"===q||(e.amaran({theme:"user message thread_"+s,content:{img:i,user:t,message:a},sticky:!0,closeOnClick:!1,closeButton:!0,delay:1e4,thread_id:s,position:"bottom right",onClick:function(){if("1"!=BP_Messages.realtime||"1"!=BP_Messages.miniChats||be)if(be){var a=e("#bp-better-messages-mini-mobile-open");if(a.length>0){var t=BP_Messages.url;BP_Messages.url=BP_Messages.threadUrl+this.thread_id,a.click(),BP_Messages.url=t,e(".amaran.user.message.thread_"+s).remove()}else location.href=BP_Messages.threadUrl+this.thread_id}else{var i=location.href=BP_Messages.threadUrl+this.thread_id+"&acceptCall",n=e(".bp-messages-wrap.bp-messages-wrap-main");n.length>0?P(i,n):location.href=i}else S(this.thread_id,!0),e(".amaran.user.message.thread_"+s).remove()}}),e(".bpbm-gifs-icon").html(ge.gif)),void 0!==a.count_unread?"0"!==a.count_unread&&E(a.id):E(a.id)}}function J(){e("*:not(.bp-messages-hide-on-mobile)").filter(function(){return("fixed"===e(this).css("position")||"absolute"===e(this).css("position"))&&!e(this).hasClass("bp-messages-wrap")&&0===e(this).closest(".uppy").length&&0===e(this).closest(".bp-messages-wrap").length}).addClass("bp-messages-hide-on-mobile")}function T(s){var a=new e.Deferred;return e.post(BP_Messages.ajaxUrl,{action:"bp_messages_get_pm_thread",user_id:s},function(e){if(be&&"1"===BP_Messages.mobileFullScreen)BP_Messages.threadUrl;else S(e,!0).always(function(e){a.resolve(!0)})}),a.promise()}function S(a,t,i){var n=new e.Deferred;if(void 0===i&&(i=!1),"1"!=BP_Messages.miniChats||Me.indexOf(a)>-1)n.reject(!1);else{var r=e('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+a+'"]');if(r.length>0&&!i){if(!K){var o=r.find(".head");r.addClass("open"),r.removeClass("blink");var l=0,c=setInterval(function(){o.toggleClass("blink"),++l>=6&&clearInterval(c)},500)}n.reject(!1)}else{Me.push(a);var p="?action=bp_messages_load_via_ajax&thread_id="+a+"&mini=1",m=BP_Messages.ajaxUrl+p;e.ajax({method:"GET",url:m,dataType:"json",cache:!1,success:function(i){void 0!==i.total_unread&&s(i.total_unread);var r=i.html,o=e(r),l=o.find(".chat-header"),c="",p=l.find(".expandingButtons");p.length>0&&(c+=p[0].outerHTML.replace("fa-ellipsis-v","fa-ellipsis-h"),p.remove());var m=l.find(".video-call");m.length>0&&(c+='<span class="video-call" data-user-id="'+m.data("user-id")+'" title="'+BP_Messages.strings.video_call+'"><i class="fas fa-video"></i></span>',m.remove());var g=l.find(".audio-call");g.length>0&&(c+='<span class="audio-call" data-user-id="'+g.data("user-id")+'" title="'+BP_Messages.strings.audio_call+'"><i class="fas fa-phone"></i></span>',g.remove()),l=l.html().trim(),o.find(".chat-header").remove();var h="chat";1==t&&(h+=" open"),"1"===BP_Messages.disableEnterForDesktop&&(h+=" enter-disabled");var b='<div class="'+h+'" data-thread="'+a+'" style="visibility: hidden">';b+='<div class="head"><span class="unread-count count-0"></span><span class="title">'+l+"</span>",b+='<div class="controls">\n'+c+'<span class="open" title="'+BP_Messages.strings.maximize+'"><i class="fas fa-window-maximize" aria-hidden="true"></i></span>\n<span class="close" title="'+BP_Messages.strings.close+'"><i class="fas fa-times" aria-hidden="true"></i></span>\n</div></div>',b+=o.html(),b+="</div>";var u=e('.bp-better-messages-mini .chats .chat[data-thread="'+a+'"]');u.length>0?u.replaceWith(b):e(b).appendTo(".bp-messages-wrap.bp-better-messages-mini .chats"),Y[a]=t,store.set("bp-better-messages-mini-chats",Y),delete Me[Me.indexOf(a)],d(),!0===t&&W.emit("threadOpen",a),j(),n.resolve(!0)},statusCode:{403:function(s){"object"==typeof s.responseJSON&&e.each(s.responseJSON,function(){BBPMShowError(this)}),delete Me[Me.indexOf(a)],delete Y[a],store.set("bp-better-messages-mini-chats",Y),n.resolve(!0)}}})}}return n.promise()}function j(){clearTimeout(Pe),Pe=setTimeout(function(){e(".bp-messages-wrap.bp-better-messages-mini .chats .chat").each(function(){var s=e(this).data("thread");parseInt(e(".bp-messages-wrap.bp-better-messages-mini").outerHeight())-parseInt(e(this).position().top+e(this).outerHeight())>1&&(e(this).remove(),void 0!==Y[s]&&delete Y[s],store.set("bp-better-messages-mini-chats",Y))}),e(".bp-messages-wrap.bp-better-messages-mini .chats .chat").css("visibility","visible")},100)}function Q(){e("span.writing").each(function(){var s=e(this),a=s.closest(".bp-messages-threads-wrapper"),t=a.find(".reply").outerHeight(),i=a.find(".bpbm-preview-message").outerHeight();void 0!==i&&(t+=i),s.css("bottom",t)})}function D(s,a){var t;a<1?(t="",e('.threads-list .thread[data-id="'+s+'"], .bp-better-messages-mini .chat[data-thread="'+s+'"]').removeClass("unread"),e('.bp-messages-wrap .messages-list li[data-thread="'+s+'"]').removeClass("unread")):(t="+"+a,e('.threads-list .thread[data-id="'+s+'"], .bp-better-messages-mini .chat[data-thread="'+s+'"]').addClass("unread")),e('.threads-list .thread[data-id="'+s+'"] .time .unread-count').text(t),e('.bp-better-messages-mini .chat[data-thread="'+s+'"] .unread-count').attr("class","unread-count count-"+a).text(a)}function E(e){if("1"!==BP_Messages.enableSound||"dnd"===BP_Messages.userStatus)return!1;"string"==typeof e&&"tmp_"!==e.substr(0,4)&&he.notification.play()}function U(e,s,a){if(a){var t=new Date;t.setTime(t.getTime()+24*a*60*60*1e3);i="; expires="+t.toUTCString()}else var i="";document.cookie=e+"="+s+i+"; path=/"}function I(e){for(var s=e+"=",a=document.cookie.split(";"),t=0;t<a.length;t++){for(var i=a[t];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(s))return i.substring(s.length,i.length)}return null}function L(e){var s="[\\?&]"+(e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"))+"=([^&#]*)",a=new RegExp(s).exec(window.location.search);return null==a?"":decodeURIComponent(a[1].replace(/\+/g," "))}function O(e){parseInt(e%1e3/100);var s=Math.floor(e/1e3%60),a=Math.floor(e/6e4%60),t=Math.floor(e/36e5%24);return t=t<10?"0"+t:t,a=a<10?"0"+a:a,s=s<10?"0"+s:s,"00"!==t?t+":"+a+":"+s:a+":"+s}function A(s){s.each(function(){var s=BPBMJQ(this),a=s.find(".chat-header:not(.side-header)"),t=a.find("> strong"),i=a.find("> .user"),n=0;a.find("> a:visible:not(.user),> div:visible").each(function(){n+=e(this).width()});var r=n+10;t.length>0&&t.css("width","calc(100% - "+r+"px)"),i.length>0&&i.css("max-width","calc(100% - "+r+"px)"),s.find(".chats .chat").each(function(){var s=BPBMJQ(this).find("> .head"),a=s.find("> .title"),t=0;s.find("> div.controls").each(function(){t+=e(this).width()});var i=t+40;a.length>0&&a.css("max-width","calc(100% - "+i+"px)")})})}function z(e){var s=e.find(".chat-header").height(),a=e.find(".preloader");a.show(),a.parent().hasClass("bp-messages-column")||(a.css("top",s),a.css("height","calc(100% - "+s+"px)"))}var H,N,W,R,$,F={},Y={},q=!1,X=[],Z=!1,G={},V={},K=!1,ee=!1,se=0!==e('html[dir="rtl"]').length,ae=window.RTCPeerConnection||window.webkitRTCPeerConnection,te=window.mozRTCSessionDescription||window.RTCSessionDescription,ie=!1,ne=!1,re=document.title,oe='<div class="loading-messages"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>',le=".bp-messages-wrap .list .messages-stack.incoming .content .messages-list li .message-content",ce=".bp-messages-wrap .list .messages-stack.outgoing .content .messages-list li .message-content",de=".bp-messages-wrap .threads-list .thread";if(store.enabled&&"1"==BP_Messages.realtime){var pe=store.get("bp-better-messages-last-unread");void 0!==pe&&parseInt(BP_Messages.total_unread)!==parseInt(pe)&&s(pe)}ifvisible.setIdleDuration(3);var me={},ge={gif:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="5.002 9.969 23.017 13.042">\n<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n<g fill="currentColor">\n<path d="M8.00684834,10 C6.34621185,10 5,11.3422643 5,12.9987856 L5,20.0012144 C5,21.6573979 6.33599155,23 8.00684834,23 L24.9931517,23 C26.6537881,23 28,21.6577357 28,20.0012144 L28,12.9987856 C28,11.3426021 26.6640085,10 24.9931517,10 L8.00684834,10 L8.00684834,10 Z M7.99456145,11 C6.89299558,11 6,11.9001762 6,12.992017 L6,20.007983 C6,21.1081436 6.90234375,22 7.99456145,22 L25.0054385,22 C26.1070044,22 27,21.0998238 27,20.007983 L27,12.992017 C27,11.8918564 26.0976562,11 25.0054385,11 L7.99456145,11 L7.99456145,11 Z M13,17 L13,19 L10.9998075,19 C10.4437166,19 10,18.5523709 10,18.0001925 L10,14.9998075 C10,14.4437166 10.4476291,14 10.9998075,14 L14,14 L14,13 L11.0048815,13 C9.89761602,13 9,13.8865548 9,15.0059191 L9,17.9940809 C9,19.1019194 9.8938998,20 11.0048815,20 L14,20 L14,19.25 L14,19.25 L14,17 L14,16 L11,16 L11,17 L13,17 L13,17 Z M16,14 L16,19 L15,19 L15,20 L18,20 L18,19 L17,19 L17,14 L18,14 L18,13 L15,13 L15,14 L16,14 L16,14 Z M20,16 L20,14 L24,14 L24,13 L19,13 L19,20 L20,20 L20,17 L23,17 L23,16 L20,16 L20,16 Z"/>\n</g>\n</g>\n</svg>'};me={seen:'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\nviewBox="0 0 25 16" style="enable-background:new 0 0 25 16;" xml:space="preserve"><g>\n<path fill="currentColor" d="M1.5,9.4c0.1-0.2,0.2-0.5,0.4-0.6C2.3,8.6,2.7,8.6,3,8.9c0.7,0.7,1.5,1.5,2.2,2.2c0.6,0.6,1.2,1.2,1.9,1.9\n\t\tc0,0,0,0,0.1,0.1c0.2-0.3,0.4-0.5,0.7-0.8c1-1.2,1.9-2.3,2.9-3.5c1.5-1.8,3-3.7,4.5-5.5c0.6-0.7,1.2-1.4,1.8-2.1\n\t\tc0.4-0.5,1.3-0.5,1.5,0.2c0.1,0.3,0.1,0.6-0.1,0.9c-0.6,0.8-1.3,1.5-1.9,2.3c-0.9,1.1-1.8,2.2-2.7,3.2c-0.9,1.1-1.8,2.1-2.6,3.2\n\t\tc-0.9,1.1-1.9,2.2-2.8,3.4c-0.2,0.2-0.4,0.4-0.5,0.7C7.6,15.3,7,15.4,6.6,15c-0.6-0.6-1.2-1.2-1.8-1.8c-0.9-0.9-1.8-1.8-2.8-2.8\n\t\tc-0.1-0.1-0.2-0.2-0.3-0.3C1.7,10,1.6,9.9,1.5,9.7C1.5,9.6,1.5,9.5,1.5,9.4z"/><path fill="currentColor"  d="M23.5,1.7c0,0.3-0.3,0.5-0.4,0.7c-1.4,1.7-2.7,3.3-4.1,5c-1.4,1.7-2.9,3.5-4.3,5.2c-0.6,0.7-1.2,1.5-1.8,2.2\n\t\tc-0.4,0.5-0.9,0.5-1.4,0.1c-0.3-0.3-0.6-0.6-0.8-0.8c-0.3-0.3-0.3-0.6-0.2-1c0.1-0.4,0.4-0.5,0.8-0.6c0.2,0,0.5,0.1,0.6,0.2\n\t\tc0.1,0.1,0.1,0.1,0.2,0.2c0.2-0.2,0.3-0.4,0.4-0.5c1-1.2,2-2.4,2.9-3.5c1.3-1.6,2.7-3.2,4-4.8c0.8-1,1.7-2,2.5-3.1\n\t\tc0.2-0.3,0.5-0.4,0.9-0.3c0.4,0.1,0.6,0.3,0.7,0.7c0,0,0,0,0,0C23.5,1.6,23.5,1.7,23.5,1.7z"/></g></svg>',delivered:'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n\t viewBox="0 0 25 16" style="enable-background:new 0 0 25 16;" xml:space="preserve">\n<g>\n\t<path fill="currentColor" d="M1.5,9.4c0.1-0.2,0.2-0.5,0.4-0.6C2.3,8.6,2.7,8.6,3,8.9c0.7,0.7,1.5,1.5,2.2,2.2c0.6,0.6,1.2,1.2,1.9,1.9\n\t\tc0,0,0,0,0.1,0.1c0.2-0.3,0.4-0.5,0.7-0.8c1-1.2,1.9-2.3,2.9-3.5c1.5-1.8,3-3.7,4.5-5.5c0.6-0.7,1.2-1.4,1.8-2.1\n\t\tc0.4-0.5,1.3-0.5,1.5,0.2c0.1,0.3,0.1,0.6-0.1,0.9c-0.6,0.8-1.3,1.5-1.9,2.3c-0.9,1.1-1.8,2.2-2.7,3.2c-0.9,1.1-1.8,2.1-2.6,3.2\n\t\tc-0.9,1.1-1.9,2.2-2.8,3.4c-0.2,0.2-0.4,0.4-0.5,0.7C7.6,15.3,7,15.4,6.6,15c-0.6-0.6-1.2-1.2-1.8-1.8c-0.9-0.9-1.8-1.8-2.8-2.8\n\t\tc-0.1-0.1-0.2-0.2-0.3-0.3C1.7,10,1.6,9.9,1.5,9.7C1.5,9.6,1.5,9.5,1.5,9.4z"/>\n\t<path fill="currentColor" d="M23.5,1.7c0,0.3-0.3,0.5-0.4,0.7c-1.4,1.7-2.7,3.3-4.1,5c-1.4,1.7-2.9,3.5-4.3,5.2c-0.6,0.7-1.2,1.5-1.8,2.2\n\t\tc-0.4,0.5-0.9,0.5-1.4,0.1c-0.3-0.3-0.6-0.6-0.8-0.8c-0.3-0.3-0.3-0.6-0.2-1c0.1-0.4,0.4-0.5,0.8-0.6c0.2,0,0.5,0.1,0.6,0.2\n\t\tc0.1,0.1,0.1,0.1,0.2,0.2c0.2-0.2,0.3-0.4,0.4-0.5c1-1.2,2-2.4,2.9-3.5c1.3-1.6,2.7-3.2,4-4.8c0.8-1,1.7-2,2.5-3.1\n\t\tc0.2-0.3,0.5-0.4,0.9-0.3c0.4,0.1,0.6,0.3,0.7,0.7c0,0,0,0,0,0C23.5,1.6,23.5,1.7,23.5,1.7z"/>\n</g>\n</svg>',sent:'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n\t viewBox="0 0 25 16" style="enable-background:new 0 0 25 16;" xml:space="preserve">\n<path fill="currentColor" d="M3.9,9.4C4,9.2,4.1,8.9,4.3,8.8c0.4-0.2,0.8-0.2,1.1,0.1c0.7,0.7,1.5,1.5,2.2,2.2c0.6,0.6,1.2,1.2,1.9,1.9\n\tc0,0,0,0,0.1,0.1c0.2-0.3,0.4-0.5,0.7-0.8c1-1.2,1.9-2.3,2.9-3.5c1.5-1.8,3-3.7,4.5-5.5c0.6-0.7,1.2-1.4,1.8-2.1\n\tc0.4-0.5,1.3-0.5,1.5,0.2c0.1,0.3,0.1,0.6-0.1,0.9C20.2,3,19.6,3.7,19,4.5c-0.9,1.1-1.8,2.2-2.7,3.2c-0.9,1.1-1.8,2.1-2.6,3.2\n\tc-0.9,1.1-1.9,2.2-2.8,3.4c-0.2,0.2-0.4,0.4-0.5,0.7C10,15.3,9.4,15.4,9,15c-0.6-0.6-1.2-1.2-1.8-1.8c-0.9-0.9-1.8-1.8-2.8-2.8\n\tc-0.1-0.1-0.2-0.2-0.3-0.3C4.1,10,4,9.9,3.9,9.7C3.9,9.6,3.9,9.5,3.9,9.4z"/>\n</svg>'};var he={notification:new Howl({src:[BP_Messages.assets+"notification.mp3",BP_Messages.assets+"notification.ogg"],loop:!1,volume:BP_Messages.soundLevels.notification}),calling:new Howl({src:[BP_Messages.assets+"calling.mp3",BP_Messages.assets+"notification.ogg"],loop:!0,volume:BP_Messages.soundLevels.calling}),sent:new Howl({src:[BP_Messages.assets+"sent.mp3",BP_Messages.assets+"sent.ogg"],loop:!1,volume:BP_Messages.soundLevels.sent})};e.fn.BPBMremoveAttributes=function(){return this.each(function(){var s=e.map(this.attributes,function(e){return e.name}),a=e(this);e.each(s,function(e,s){a.removeAttr(s)})})},e(window).on("focus",function(){ifvisible.focus()}),e(window).on("blur",function(){ifvisible.blur()}),e(window).on("click",function(){e(".bp-messages-wrap .expandingButtons.expandingButtonsOpen").removeClass("expandingButtonsOpen")});var be=!1;(/iPad|iPhone|iPod/.test(navigator.userAgent)||/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(be=!0),"1"===BP_Messages.forceMobile&&(be=!0);var ue=!1;be&&(e(window).on("touchstart",function(){ue=!0}),e(window).on("touchend",function(){ue=!1}));var fe="bp-better-messages-mobile-holder";store.enabled&&(F=store.get("bp-better-messages-open-threads")||{},Y=store.get("bp-better-messages-mini-chats")||{},q=store.get("bp-better-messages-mini-messages")||!1,setInterval(w,1e3)),"1"==BP_Messages.realtime&&o(),e(document).ready(function(){function t(){if(l)return!1}se=0!==e('html[dir="rtl"]').length,$=e(".bp-messages-wrap:not(.bp-better-messages-list, #bp-better-messages-mini-mobile-open)");var n=e("#bp-better-messages-mini-mobile-container"),o=e("#bp-better-messages-mini-mobile-open");if(be||o.hide(),be&&"0"!==BP_Messages.mobileFullScreen){var l=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;e(document).on("touchmove",".bp-messages-wrap .chat-header,.bp-messages-wrap .reply",function(e){ee&&e.preventDefault()}),e(document).on("focus blur",".bp-messages-wrap textarea, .bp-messages-wrap input",function(e){setTimeout(function(){t(),v()},300)}),e(window).resize(function(){$.hasClass("bp-messages-mobile")&&t()}),$.addClass("mobile-ready");var c,p=!1;"0"===BP_Messages.disableTapToOpen?($.find(".bp-messages-mobile-tap").css("line-height",$.height()+"px"),$.on("touchend",".bp-messages-mobile-tap",function(e){if(1!=c&&!1===p){var s=BPBMJQ(e.target).closest(".bp-messages-wrap");s.hasClass("bp-messages-mobile")||(e.preventDefault(),e.stopImmediatePropagation(),i(s))}}).on("touchmove",function(e){c=!0}).on("touchstart",function(e){c=!1})):$.on("touchend",function(s){if(1!=c&&!1===p){var a=BPBMJQ(s.target).closest(".bp-messages-wrap");if(!a.hasClass("bp-messages-mobile")){s.preventDefault(),s.stopImmediatePropagation(),i(a);var t=e(s.originalEvent.target).closest(".thread");t.length>0&&t.click()}}}).on("touchmove",function(e){c=!0}).on("touchstart",function(e){c=!1})}e(document).on("click",".bp-messages-wrap .bpbm-gif .bpbm-gif-play",function(s){ne=!0;var a=e(this),t=e(this).parent().find("video");a.remove(),t[0].play(),setTimeout(function(){ne=!1},500)}),e(document).on("click",".bp-messages-wrap .mobileClose",function(s){var a=BPBMJQ(s.target).closest(".bp-messages-wrap");if(a.hasClass("bp-messages-mobile")){s.preventDefault(),s.stopImmediatePropagation(),p=!0,e("html").removeClass("bp-messages-mobile").css("overflow","auto"),a.removeClass("bp-messages-mobile").css("min-height",""),e("body").removeClass("bp-messages-mobile").css("min-height","");var t=e(window).height()-250;if(t>BP_Messages.max_height&&(t=BP_Messages.max_height),ee=!1,a.find(".bp-messages-mobile-tap").css("line-height",a.height()+"px"),a.is(n)&&n.hide(),a.is("#bp-better-messages-mobile-view-container")){var i=a;i.removeClass("bp-messages-mobile"),i.removeAttr("id");var r=e("."+fe);i.insertBefore(r),r.remove()}e(window).trigger("resize"),setTimeout(function(){p=!1},100)}}),e(document).on("click",".bp-messages-wrap .expandingButtons",function(s){s.stopPropagation(),e(this).toggleClass("expandingButtonsOpen")}),o.on("click",function(a){a.preventDefault(),o.hasClass("loading")||(o.addClass("loading"),function(a){var t=e("#bp-better-messages-mini-mobile-container");t.addClass("bp-messages-mobile"),t.find(".bp-messages-mobile-tap").remove();var i=window.innerHeight;e("html").addClass("bp-messages-mobile").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",i),$.addClass("bp-messages-mobile").css("min-height",i);var n=0;n+=$.find(".chat-header").outerHeight();var r=i-(n+=$.find(".reply").outerHeight());e(".scroller").css({"max-height":"",height:r}),J(),t.show().html('<div class="loading-messages" style="display: block;line-height: '+r+'px">\n<div class="bounce1"></div>\n<div class="bounce2"></div>\n<div class="bounce3"></div>\n</div>');var o="?action=bp_messages_load_via_ajax&mobileFullScreen=1";void 0!==a.split("?")[1]&&(o="?"+a.split("?")[1]+"&action=bp_messages_load_via_ajax&mobileFullScreen=1");var l=BP_Messages.ajaxUrl+o;e.get(l,function(a){void 0!==a.total_unread&&s(a.total_unread);var i=a.html,n=e(i).filter(".bp-messages-wrap").html();t.html(n).show(),ee=!0,d(),e("#bp-better-messages-mini-mobile-open").removeClass("loading")},"json")}(BP_Messages.baseUrl))});var m=!1,g=!1;if(e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?m=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container) .threads-list").length>0&&(g=!0),be)if("1"===BP_Messages.autoFullScreen)if(m||g){e("#bp-better-messages-mini-mobile-open, #bp-better-messages-mini-mobile-container").remove();i(h=e(".bp-messages-wrap.mobile-ready.bp-messages-wrap-main, .bp-messages-wrap.mobile-ready.bp-messages-group-thread"))}else{var h=e(".bp-messages-wrap.bp-messages-wrap-bulk.mobile-ready");h.length>0&&i(h)}else(m||g)&&e("#bp-better-messages-mini-mobile-open, #bp-better-messages-mini-mobile-container").remove();"1"===BP_Messages.blockScroll&&e(".bp-messages-wrap").on("mousewheel DOMMouseScroll",".bpbm-os-viewport",function(s){var a=s.originalEvent,t=a.wheelDelta||-a.detail,i=s.currentTarget.scrollHeight-e(s.currentTarget).height();t>0?this.scrollTop<5&&s.preventDefault():i-this.scrollTop<5&&s.preventDefault()}),d(),void 0===BP_Messages.socket_server&&setInterval(function(){e.post(BP_Messages.ajaxUrl,{action:"bp_messages_last_activity_refresh"})},3e5),$.on("click",".threads-list .thread:not(.blocked)",function(s){if(0===e(s.target).closest(".pic").length&&0===e(s.target).closest(".delete").length&&0===e(s.target).closest(".deleted").length){s.preventDefault();P(e(this).attr("data-href"),e(this).closest(".bp-messages-wrap"))}}),e(document).on("click",de+" span.delete",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).parent().parent(),t=(a.parent().parent(),e(a).attr("data-id")),i=e(a).height(),n=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_thread",thread_id:t,nonce:n},function(s){if(s.result){var t=a.position().top;e(a).addClass("blocked"),e(a).find(".deleted").show().css({height:i,"line-height":i+"px",top:t+"px"})}else BBPMShowError(s.errors[0])})}),e(document).on("click",de+" a.undelete",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).parent().parent(),t=e(a).attr("data-id");e(a).removeClass("blocked");var i=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_un_delete_thread",thread_id:t,nonce:i},function(s){s.result?(e(a).removeClass("blocked"),e(a).find(".deleted").hide()):BBPMShowError(s.errors[0])})}),$.on("click",".messages-list li .favorite",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).parentsUntil(".messages-list","li").attr("data-id"),t="star";e(this).hasClass("active")&&(t="unstar"),e(this).toggleClass("active"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_favorite",message_id:a,thread_id:N,type:t},function(e){})}),$.on("click",".messages-list li .bpbm-reply",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).closest("li"),t=a.closest(".messages-stack"),i=t.closest(".bp-messages-threads-wrapper"),n=a.attr("data-id"),r=t.find(".content .info .name a").text(),o="",l="",c=a.find(".bpbm-replied-message-reply");c.length>0?o+=c.text():o+=a.find(".message-content").text();var d=a.find(".message-content > [data-desc]");d.length>0&&d.each(function(){var s=e(this).attr("data-desc");void 0!==s&&(l+='<span class="bpbm-preview-desc">'+atob(s)+"</span>")});var p='<div class="bpbm-preview-message bpbm-reply-message" style="display:none" data-message-id="'+n+'"><div class="bpbm-preview-message-cancel"><i class="far fa-times-circle"></i></div><div class="bpbm-preview-message-content"><span class="bpbm-preview-message-name"></span><div class="bpbm-preview-message-text"></div></div></div>',m=i.find(".bpbm-preview-message");m.length>0?(m=m.replaceWith(p),(m=i.find(".bpbm-preview-message")).show(),Q()):(m=e(p).insertBefore(i.find(".reply"))).slideDown(100,function(){Q()}),m.find(".bpbm-preview-message-name").text(r),m.find(".bpbm-preview-message-text").text(o),m.find(".bpbm-preview-message-text").append(l),m.find(".bpbm-gifs-icon").html(ge.gif)}),$.on("click",".bpbm-preview-message-cancel",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).closest(".bpbm-preview-message");a.slideUp(100,function(){a.remove(),Q()})});var b,u=!1,f="";$.on("submit",".reply > form",function(s){if(s.preventDefault(),s.stopImmediatePropagation(),ifvisible.focus(),!0!==u){var t=e(this);if(t.serialize()===f)return!1;var i=a(e(this).find('textarea[name="message"]')),n=e(this).serialize(),r=N,o=!1,l=!1,c=e(this).parent().parent(),d=c.find(".thread.scroller[data-users-json]"),p=c.find(".bpbm-preview-message.bpbm-reply-message");p.length>0&&(l=!0,n+="&reply=1&message_id="+parseInt(p.attr("data-message-id")));var m=c.find(".bpbm-preview-message.bpbm-edit-message");m.length>0&&(o=!0,n+="&edit=1&message_id="+parseInt(m.attr("data-message-id")));var g=atob(d.attr("data-users-json")),h=Object.keys(e.parseJSON(g));if(e(this).closest(".bp-better-messages-mini").length>0&&(r=e(this).closest(".chat").attr("data-thread")),"1"===BP_Messages.encryption){var _=d.data("secret");i=BPBMAES256.encrypt(i,_)}!r||"1"!=BP_Messages.realtime||o||l?e.post(BP_Messages.ajaxUrl,n,function(s){void 0!==s.result&&(!1!==s.result?(B(),e(document).trigger("bp-better-messages-message-sent"),o||(he.sent.play(),v('.bp-messages-wrap[data-thread-id="'+r+'"]'),v('.bp-better-messages-mini .chats .chat[data-thread="'+r+'"]')),f=n,clearInterval(b),b=setInterval(function(){f=""},3e3),l&&p.find(".bpbm-preview-message-cancel").click(),o&&(m.find(".bpbm-preview-message-cancel").click(),"1"!=BP_Messages.realtime&&P(location.href,t.closest(".bp-messages-wrap")))):(e.each(s.errors,function(){BBPMShowError(this)}),void 0!==s.redirect&&"refresh"===s.redirect&&P(location.href,t.closest(".bp-messages-wrap"))))}).always(function(){u=!1}):W.emit("fast_message",r,i,h,function(s){f=n,clearInterval(b),b=setInterval(function(){f=""},3e3),e(document).trigger("bp-better-messages-message-sent"),he.sent.play(),v('.bp-messages-wrap[data-thread-id="'+r+'"]'),v('.bp-better-messages-mini .chats .chat[data-thread="'+r+'"]'),n+="&tempID="+s,e.post(BP_Messages.ajaxUrl,n,function(s){if(void 0!==s.result&&(e.each(s.errors,function(){BBPMShowError(this)}),void 0!==s.redirect&&"refresh"===s.redirect)){t.closest(".bp-messages-wrap").hasClass("bp-better-messages-mini")?(e('.bp-better-messages-mini .chats .chat[data-thread="'+r+'"]').remove(),S(r,!0)):P(location.href,t.closest(".bp-messages-wrap"))}}).always(function(){u=!1})}),e(this).find("textarea, .bp-emojionearea-editor").html("").val(""),e(document).trigger("bp-better-messages-message-sent-end")}}),$.on("click ",".bpbm-stickers-selector .bpbm-stickers-selector-sticker",function(s){s.preventDefault(),s.stopPropagation();var a=e(this),t=a.closest(".bpbm-stickers-selector"),i=t.parent().find(".reply form"),n=a.data("sticker-id"),o=a.find("img").attr("src"),l=i.find('input[name="thread_id"]').val(),c=i.find('input[name="_wpnonce"]').val();t.hide(),r(),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_send_sticker",thread_id:l,sticker_id:n,sticker_img:o,_wpnonce:c},function(e){})}),$.on("click ",".bpbm-gifs-selector .bpbm-gifs-selector-gif",function(s){s.preventDefault(),s.stopPropagation();var a=e(this),t=a.closest(".bpbm-gifs-selector"),i=t.parent().find(".reply form"),n=a.data("gif-id"),o=i.find('input[name="thread_id"]').val(),l=i.find('input[name="_wpnonce"]').val();t.hide(),r(),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_send_gif",thread_id:o,gif_id:n,_wpnonce:l},function(e){})}),$.on("click touchstart",".reply .bpbm-stickers-btn",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).closest(".reply"),t=a.parent(),i=a.find("form").find("textarea"),n=t.find(".bpbm-stickers-selector");i.blur(),n.is(":visible")||n.show()}),$.on("click touchstart",".reply .bpbm-gifs-btn",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).closest(".reply"),t=a.parent(),i=a.find("form").find("textarea"),n=t.find(".bpbm-gifs-selector");i.blur(),n.is(":visible")||(n.show(),n.find('.bpbm-gifs-tabs span[data-package-id="trending"]').click())}),$.on("click",".bpbm-gifs-selector .bpbm-gifs-close",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).closest(".bpbm-gifs-selector");a.hide(),a.find(".bpbm-gifs-tabs .bpbm-gifs-tabs-active").removeClass("bpbm-gifs-tabs-active"),a.find(".bpbm-gifs-selector-gif-list").html("")}),$.on("click",".bpbm-gifs-selector .bpbm-gifs-head .bpbm-gifs-tabs span",function(s){s.preventDefault(),s.stopPropagation();var a=e(this),t=a.closest(".bpbm-gifs-selector"),i=t.find(".bpbm-gifs-selector-gif-container");if(!a.hasClass("bpbm-gifs-tabs-active")){t.find(".bpbm-gifs-tabs span").removeClass("bpbm-gifs-tabs-active"),a.addClass("bpbm-gifs-tabs-active"),i.html(oe);var n=a.data("package-id");e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_get_gif_tab",package:n},function(s){if(i.html(s),"trending"===n){i.on("scroll",function(s){s.stopImmediatePropagation();var a=e(s.currentTarget),t=a.outerHeight()+150;if(a[0].scrollHeight-a.scrollTop()<=t){var r=i.find(".bpbm-gifs-selector-gif-list");if(!r.hasClass("bpbm-loading-gifs")){var o=r.data("pages"),l=r.data("pages-loaded")+1;l<o&&(r.addClass("bpbm-loading-gifs"),_=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_get_gif_tab",package:n,page:l},function(s){r.data("pages-loaded",l),e(s).appendTo(r),r.removeClass("bpbm-loading-gifs")}))}}})}})}}),$.on("click",".bpbm-stickers-selector .bpbm-stickers-close",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).closest(".bpbm-stickers-selector");a.parent();a.hide()}),$.on("click",".bpbm-stickers-selector .bpbm-stickers-head .bpbm-stickers-tabs span",function(s){s.preventDefault(),s.stopPropagation();var a=e(this),t=a.closest(".bpbm-stickers-selector"),i=t.find(".bpbm-stickers-selector-sticker-container");t.find(".bpbm-stickers-tabs span").removeClass("bpbm-stickers-tabs-active"),a.addClass("bpbm-stickers-tabs-active"),i.html(oe);var n=a.data("package-id");e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_get_sticker_tab",package:n},function(e){i.html(e)})});var _;$.on("keyup change",'.bpbm-gifs-tabs input[name="search"]',function(s){s.preventDefault(),s.stopPropagation();var a=e(this),t=a.closest(".bpbm-gifs-selector"),i=t.find(".bpbm-gifs-selector-gif-container"),n=t.find(".bpbm-gifs-selector-gif-list"),r=a.data("search-term"),o=a.val();if(r!==o){a.data("search-term",o),_&&_.abort();n.addClass("bpbm-loading-gifs"),_=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_gifs",search:o},function(s){n.replaceWith(s),i.on("scroll",function(s){s.stopImmediatePropagation();var a=e(s.currentTarget),i=a.outerHeight()+150;if(a[0].scrollHeight-a.scrollTop()<=i&&!(n=t.find(".bpbm-gifs-selector-gif-list")).hasClass("bpbm-loading-gifs")){var r=n.data("pages"),l=n.data("pages-loaded")+1;l<r&&(n.addClass("bpbm-loading-gifs"),_=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_gifs",search:o,page:l},function(s){n.data("pages-loaded",l),e(s).appendTo(n),n.removeClass("bpbm-loading-gifs")}))}})})}});var w;if($.on("keyup change",".bpbm-stickers-selector .bpbm-stickers-search input",function(s){s.preventDefault(),s.stopPropagation();var a=e(this),t=a.closest(".bpbm-stickers-search"),i=a.closest(".bpbm-stickers-selector"),n=i.find(".bpbm-stickers-selector-sticker-list"),r=t.data("search-term"),o=a.val();r!==o&&(t.data("search-term",o),w&&w.abort(),w=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_stickers",search:o},function(s){n.replaceWith(s),(n=i.find(".bpbm-stickers-selector-sticker-list")).BPBMoverlayScrollbars({sizeAutoCapable:!1,callbacks:{onScroll:function(s){var a=this.scroll(),t=a.position.y;if(a.max.y-t<=10){var i=this.getElements(),n=BPBMJQ(i.host);if(!n.hasClass("bpbm-loading-stickers")){var r=n.data("pages"),l=n.data("pages-loaded")+1;l<=r&&(n.addClass("bpbm-loading-stickers"),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_stickers",search:o,page:l},function(s){n.data("pages-loaded",l),e(s).appendTo(BPBMJQ(i.content)),n.removeClass("bpbm-loading-stickers")}))}}}}})}))}),$.on("submit",".new-message form",function(s){s.preventDefault(),s.stopPropagation();var t=BPBMJQ(s.target).closest(".bp-messages-wrap");z(t);a(e(this).find('textarea[name="message"]'));var i=e(this),n=i.serialize();e.post(BP_Messages.ajaxUrl,n,function(s){s.result?P(BP_Messages.threadUrl+s.result,t):(i.closest(".bp-messages-wrap").find(".preloader").hide(),e.each(s.errors,function(){BBPMShowError(this)}))}).fail(function(){i.closest(".bp-messages-wrap").find(".preloader").hide()})}),$.on("click","a.ajax",function(s){s.preventDefault(),s.stopPropagation();P(e(this).attr("href"),e(this).closest(".bp-messages-wrap"))}),$.on("click",".bpbm-search a.search",function(s){s.preventDefault(),s.stopPropagation(),e(this).hide(),e(".bpbm-search form").show(),e(".bpbm-search form input").trigger("focus"),be&&e(".bp-messages-wrap .chat-header .settings").hide()}),$.on("click",".bpbm-search form span.close",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).closest(".bpbm-search"),t=a.find("form input");a.closest(".bp-messages-side-threads").length>0?(t.val(""),t.trigger("change"),a.find("form .close").hide()):(a.find("form").hide(),a.find("a.search").show(),t.val(""))}),$.on("submit",".bpbm-search form",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap");P(BP_Messages.url+"?"+e(this).serialize(),a)}),!1===("1"===BP_Messages.disableEnterForTouch&&be||"1"===BP_Messages.disableEnterForDesktop&&!be)&&$.on("keydown",".reply .bp-emojionearea-editor",function(s){s.shiftKey||13!=s.keyCode||(s.preventDefault(),s.stopImmediatePropagation(),e(this).trigger("blur"),e(this).parent().parent().trigger("submit"),e(this).trigger("focus"))}),$.on("change",".new-message .send-to-input",function(s){s.preventDefault(),s.stopPropagation();P(e(this).attr("href"),e(this).closest(".bp-messages-wrap"))}),be?$.on("touchend",".scroller.starred .messages-list li, .scroller.search .messages-list li",function(s){if(1!=c&&!1===p){s.preventDefault(),s.stopPropagation();var a=e(this).attr("data-thread"),t=e(this).attr("data-id");P(BP_Messages.threadUrl+a+"&message_id="+t,e(this).closest(".bp-messages-wrap"))}}).on("touchmove",function(e){c=!0}).on("touchstart",function(e){c=!1}):$.on("click",".scroller.starred .messages-list li, .scroller.search .messages-list li",function(s){s.preventDefault(),s.stopPropagation();var a=e(this).attr("data-thread"),t=e(this).attr("data-id");P(BP_Messages.threadUrl+a+"&message_id="+t,e(this).closest(".bp-messages-wrap"))}),$.on("click",".participants-panel .bp-messages-user-list .user .actions a.remove-from-thread",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap"),t=e(this).parent().parent(),i=t.data("id"),n=t.data("thread-id"),r=t.find(".name").text(),o=BP_Messages.strings.exclude;a.hasClass("bp-messages-wrap-chat")&&(o=BP_Messages.strings.exclude_chat),o=o.replace("%s",r);confirm(o)&&e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_exclude_user_from_thread",user_id:i,thread_id:n},function(s){if(!0===s.result){P(BP_Messages.url+"?"+e.param({thread_id:n,participants:"1"}),a)}})}),$.on("click",".bpbm-mute-thread",function(s){s.preventDefault();var a,t=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,n=location.href;if(i?a=e(this).closest(".chat").attr("data-thread"):(a=t.attr("data-thread-id"),t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),n=BP_Messages.baseUrl+"?thread_id="+a)),void 0===a)return!1;-1===n.indexOf("?thread_id=")&&(n=BP_Messages.baseUrl+"?thread_id="+a);confirm(BP_Messages.strings.mute_thread)&&(z(i?e(this).closest(".chat"):t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_mute_thread",thread_id:a},function(s){i?S(a,!0,!0):P(n,t);e(de+'[data-id="'+a+'"] .bpbm-counter-row').prepend('<span class="bpbm-thread-muted"><i class="fas fa-bell-slash"></i></span>'),BP_Messages.mutedThreads[a]=Date.now()}).always(function(){}))}),$.on("click",".bpbm-leave-thread",function(s){s.preventDefault();var a,t=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0;location.href;if(i?a=e(this).closest(".chat").attr("data-thread"):(a=t.attr("data-thread-id"),t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),BP_Messages.baseUrl+"?thread_id="+a)),void 0===a)return!1;confirm(BP_Messages.strings.leave_thread)&&(z(i?e(this).closest(".chat"):t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_leave_thread",thread_id:a},function(s){s?(void 0!==W&&W.emit("threadOpen",a),e(de+'[data-id="'+a+'"]').remove(),i?e('.bp-better-messages-mini .chats .chat[data-thread="'+a+'"] > .head .close').click():P(BP_Messages.baseUrl,t)):t.find(".preloader").hide()}))}),$.on("click",".bpbm-delete-thread",function(s){s.preventDefault();var a,t=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,n=location.href;if(i?a=e(this).closest(".chat").attr("data-thread"):(a=t.attr("data-thread-id"),t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),n=BP_Messages.baseUrl)),void 0===a)return!1;-1===n.indexOf("?thread_id=")&&(n=BP_Messages.baseUrl);confirm(BP_Messages.strings.delete_thread)&&(z(i?e(this).closest(".chat"):t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_erase_thread",thread_id:a,_wpnonce:BP_Messages.editNonce},function(s){e('.bp-messages-wrap .threads-list .thread[data-id="'+a+'"]').remove(),e('.bp-better-messages-mini .chats .chat[data-thread="'+a+'"] .head span.close').click(),i||P(n,t)}).always(function(){}))}),$.on("click",".bpbm-clear-thread",function(s){s.preventDefault();var a,t=e(this).closest(".bp-messages-wrap"),i=t.hasClass("bp-messages-wrap-chat"),n=e(this).closest(".bp-better-messages-mini").length>0,r=location.href;if(n?a=e(this).closest(".chat").attr("data-thread"):(a=t.attr("data-thread-id"),t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),r=BP_Messages.baseUrl)),void 0===a)return!1;-1===r.indexOf("?thread_id=")&&(r=BP_Messages.baseUrl),i&&(r=BP_Messages.baseUrl+"?thread_id="+a);confirm(BP_Messages.strings.clear_chat_thread)&&(z(n?e(this).closest(".chat"):t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_clear_thread",thread_id:a,_wpnonce:BP_Messages.editNonce},function(e){n?S(a,!0,!0):P(r,t)}).always(function(){}))}),$.on("click",".chat-header .bpbm-invite-thread",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap"),t=a.find(".add-user-panel"),i=a.find(".scroller.thread"),n=a.find(".participants-panel");t.hasClass("open")||(t.addClass("open"),n.removeClass("open"),i.hide())}),$.on("click",".chat-header .participants",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap"),t=a.find(".participants-panel"),i=a.find(".scroller.thread"),n=a.find(".add-user-panel"),r=parseInt(a.attr("data-thread-id"));t.hasClass("participants-loaded")||(t.addClass("participants-loaded"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_load_thread_participants",thread_id:r},function(e){t.find(".bp-messages-user-list").html(e)}).always(function(){})),t.hasClass("open")?(t.removeClass("open"),i.show()):(t.addClass("open"),n.removeClass("open"),i.hide())}),$.on("click",".bpbm-unmute-thread",function(s){s.preventDefault();var a,t=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,n=location.href;i?a=e(this).closest(".chat").attr("data-thread"):(a=t.attr("data-thread-id"),t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),n=BP_Messages.baseUrl+"?thread_id="+a));confirm(BP_Messages.strings.unmute_thread)&&(z(i?e(this).closest(".chat"):t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_unmute_thread",thread_id:a},function(s){void 0!==BP_Messages.mutedThreads[a]&&delete BP_Messages.mutedThreads[a],e(de+'[data-id="'+a+'"] .bpbm-counter-row .bpbm-thread-muted').remove(),i?S(a,!0,!0):P(n,t)}).always(function(){}))}),$.on("click",'.add-user button[type="submit"]',function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap"),t=e(this).closest(".add-user"),i=t.data("thread-id"),n=[];t.find('input[name="recipients[]"]').each(function(){n.push(e(this).val())}),z(a),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_add_user_to_thread",users:n,thread_id:i},function(s){P(BP_Messages.url+"?"+e.param({thread_id:i,participants:"1"}),a)})}),$.on("click",".add-user button.bpbm-close",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap"),t=a.find(".add-user-panel"),i=a.find(".scroller.thread");t.hasClass("open")&&(t.removeClass("open"),i.show())}),$.on("click",".bpbm-join-to-chat-button",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap"),t=a.data("chat-id"),i=a.data("thread-id");z(a),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_join_chat",chat_id:t},function(s){P(BP_Messages.url+"?"+e.param({thread_id:i}),a)})}),$.on("click",".bpbm-leave-chat-room",function(s){s.preventDefault();var a=e(this).closest(".bp-messages-wrap"),t=a.data("chat-id"),i=a.data("thread-id");z(a),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_leave_chat",chat_id:t},function(s){P(BP_Messages.url+"?"+e.param({thread_id:i}),a)})}),"1"==BP_Messages.miniChats&&(e(document).on("click",".bp-better-messages-mini .chats .chat > .head",function(s){var a=e(this).parent(),t=a.attr("data-thread");if(a.toggleClass("open").hasClass("open")){if(Y[t]=!0,v('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+t+'"]'),"1"==BP_Messages.realtime){d();var i=[];e('.bp-messages-wrap.bp-better-messages-mini .chats .chat[data-thread="'+t+'"] .list .messages-stack .content .messages-list li.unread:not(.fast)').each(function(){var s=e(this).data("id"),a=e(this).data("thread"),t=e(this).attr("data-time");i.push(s),e(this).removeClass("unread"),U("bp-better-messages-thread-"+a,t,1)}),W.emit("threadOpen",t),i.length>0&&W.emit("seen",i)}}else Y[t]=!1;store.set("bp-better-messages-mini-chats",Y)}),e(document).on("click",".bp-better-messages-mini .chats .chat > .head .video-call",function(s){s.stopPropagation(),s.stopImmediatePropagation();var a=BPBMJQ(this).data("user-id");if(-1===X.indexOf(a.toString()))BBPMShowError(BP_Messages.strings.call_offline);else{var t=e(this).parent().parent().parent(),i=t.attr("data-thread");t.fadeOut();var n=BP_Messages.threadUrl+i+"&videoCall",r=e(".bp-messages-wrap.bp-messages-wrap-main");r.length>0?P(n,r):location.href=n}}),e(document).on("click",".bp-better-messages-mini .chats .chat > .head .audio-call",function(s){s.stopPropagation(),s.stopImmediatePropagation();var a=BPBMJQ(this).data("user-id");if(-1===X.indexOf(a.toString()))BBPMShowError(BP_Messages.strings.call_offline);else{var t=e(this).parent().parent().parent(),i=t.attr("data-thread");t.fadeOut();var n=BP_Messages.threadUrl+i+"&audioCall",r=e(".bp-messages-wrap.bp-messages-wrap-main");r.length>0?P(n,r):location.href=n}}),e(document).on("click",".bp-better-messages-mini .chats .chat > .head .open",function(s){s.stopImmediatePropagation();var a=e(this).parent().parent().parent(),t=a.attr("data-thread");a.fadeOut();var i=BP_Messages.threadUrl+t+"&scrollToContainer",n=e(".bp-messages-wrap.bp-messages-wrap-main");n.length>0?P(i,n):location.href=i}),e(document).on("click",".bp-better-messages-mini .chats .chat > .head .close",function(s){s.stopImmediatePropagation();var a=e(this).parent().parent().parent(),t=a.attr("data-thread");a.slideUp(function(){a.remove()}),void 0!==Y[t]&&delete Y[t],store.set("bp-better-messages-mini-chats",Y)}),e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)").on("click",".chat-header > .mini-chat",function(s){var a=e(this),t=a.closest(".bp-messages-wrap").attr("data-thread-id");void 0!==Y[t]&&delete Y[t],a.hasClass("group-redirect")?(Y[t]=!0,store.set("bp-better-messages-mini-chats",Y)):S(t,!0)})),"1"==BP_Messages.miniMessages&&e(document).on("click",".bp-better-messages-list .threads-list .thread:not(.blocked)",function(s){s.preventDefault();var a=e(this),t=a.data("id");if("1"==BP_Messages.miniChats){var i=a.parent().parent(),n=e(a).height(),r=a.position().top;r+=i.scrollTop(),a.addClass("blocked loading"),e(a).find(".loading").css({height:n,"line-height":n+"px",top:r+"px"}),S(t,!0).always(function(e){d(),a.removeClass("blocked loading")})}else{var o=BP_Messages.threadUrl+t+"&scrollToContainer",l=e(".bp-messages-wrap.bp-messages-wrap-main");l.length>0?P(o,l):location.href=o}}),e(document).on("click",".bp-better-messages-list .tabs > div",function(s){s.preventDefault();var a=e(this).data("tab");"bpbm-close"===a?(e(".bp-better-messages-list .tabs > div, .bp-better-messages-list .tabs-content > div").removeClass("active"),e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').hide(),q=!1):e(this).hasClass("active")?(e(this).removeClass("active"),e(".bp-better-messages-list .tabs-content ."+a).removeClass("active"),e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').hide(),q=!1):(e(".bp-better-messages-list .tabs > div, .bp-better-messages-list .tabs-content > div").removeClass("active"),e(this).addClass("active"),e(".bp-better-messages-list .tabs-content ."+a).addClass("active"),q=a,e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').show()),store.set("bp-better-messages-mini-messages",q)}),e(document).on("click",".bpbm-deleted-user-link",function(e){e.preventDefault()}),e(document).on("click",".bp-better-messages-list .new-message",function(s){var a=e(".bp-messages-wrap.bp-messages-wrap-main");a.length>0&&(s.preventDefault(),P(e(this).attr("href"),a))}),e(document).on("click",".bp-messages-group-list .group:not(.blocked)",function(s){if(e(s.target).is("div")){s.preventDefault();var a=e(this),t=(a.data("group-id"),a.data("thread-id")),i=a.find(".actions .open-group").attr("href");"1"===BP_Messages.enableGroups&&(i+="bp-messages/?scrollToContainer");var n=a.parent().parent(),r=a.height(),o=a.position().top;o+=n.scrollTop(),a.find(".loading").css({height:r,"line-height":r+"px",top:o+"px"}),a.addClass("blocked loading"),"1"===BP_Messages.enableGroups&&"1"==BP_Messages.miniChats&&t?S(t,!0).always(function(e){a.removeClass("blocked loading")}):location.href=i}}),e(document).on("click",".bp-messages-user-list .user:not(.blocked)",function(s){if(e(s.target).is("div")){s.preventDefault();var a=e(this),t=e(this).data("id"),i=e(this).data("username");if("1"==BP_Messages.miniChats&&"1"==BP_Messages.fastStart){var n=a.parent().parent(),r=e(a).height(),o=a.position().top;o+=n.scrollTop(),e(a).find(".loading").css({height:r,"line-height":r+"px",top:o+"px"}),a.addClass("blocked loading"),T(t).always(function(e){a.removeClass("blocked loading")})}else{var l=BP_Messages.url+"?new-message&to="+i;"1"==BP_Messages.fastStart&&(l+="&fast=1&scrollToContainer");var c=e(".bp-messages-wrap.bp-messages-wrap-main");c.length>0?P(l,c):location.href=l}}}),"1"===BP_Messages.enablePushNotifications&&"serviceWorker"in navigator&&"PushManager"in window){!1===store.get("bpbm-browser-push-proposal-clicked",!1)&&navigator.serviceWorker.register("/bpbm-worker.js",{scope:"/"}).then(function(e){e.pushManager.getSubscription().then(function(e){null===e&&BPBMJQ.amaran({theme:"colorful",content:{bgcolor:"black",color:"#fff",message:'<span class="bpbm-browser-push-proposal"><span class="bpbm-browser-push-proposal-text">'+BP_Messages.strings.push_request+'</span><span class="bpbm-browser-push-proposal-controls"><button class="BPBMenablePushNotifications">'+BP_Messages.strings.enable+'</button><button class="BPBMdismissPushProposal">'+BP_Messages.strings.dismiss+"</button></span></span>"},sticky:!0,closeOnClick:!0,closeButton:!1,position:"bottom right",onClick:function(){store.set("bpbm-browser-push-proposal-clicked",!0)}})})})}e(document).on("click",".bp-messages-wrap .bpbm-user-me",function(s){s.preventDefault(),e(this).toggleClass("bpbm-open")}),e(document).on("click",".bp-messages-wrap .bpbm-user-me .bpbm-user-me-popup .bpbm-user-me-popup-list-item",function(s){s.stopImmediatePropagation();var a=e(this);if(!a.is("a")){s.preventDefault();var t=a.closest(".bpbm-user-me-popup"),i=t.closest(".bpbm-user-me"),n=a.attr("data-status");i.removeClass("bpbm-open"),BPBMJQ.post(BP_Messages.ajaxUrl,{action:"bp_messages_change_user_option",option:"online_status",user_id:BP_Messages.user_id,value:n,_wpnonce:t.attr("data-nonce")},function(s){!0===s.result?e(".bpbm-user-me .current-status").html(s.message):BBPMShowError(s.errors.join("\n"))})}})}),BPBMJQ(document).on("bp-better-messages-update-unread",function(e){var s=BPBMJQ(".bp-better-messages-unread");if(V=parseInt(e.detail.unread),(isNaN(V)||V<0)&&(V=0),store.set("bp-better-messages-last-unread",V),s.each(function(){var e=BPBMJQ(this),s=e.hasClass("bpbmuc");e.text(V),s?e.attr("data-count",V):0===V?e.addClass("no-count"):e.removeClass("no-count")}),BPBMJQ("body").hasClass("my-account")){var a=BPBMJQ("#user-bp_better_messages_tab");if(a.length>0){var t=a.find("span.count");V>0?t.length>0?t.text(V):BPBMJQ('<span class="count">'+V+"</span>").appendTo(a):t.remove()}}});var ve=!1,_e=!1,Be=!1;BPBMJQ(document).on("bp-better-messages-refresh-thread",function(e){B()}),e(document).on("submit",".side-header > .bpbm-search form",function(e){e.preventDefault(),e.stopImmediatePropagation()});var we=!1;e(document).on("change keyup",'.side-header > .bpbm-search input[name="search"]',function(s){var a=e(this),t=a.val().trim(),i=a.closest("form").find(".close"),n=a.closest(".bp-messages-side-threads"),r=n.find(".bpbm-search-results"),o=n.find(".threads-list");a.data("search-term")!==t&&(""===t?(o.show(),r.hide(),i.hide(),a.data("search-term",t)):(r.show(),i.show(),o.hide(),we&&we.abort(),0===r.find(".loading-messages").length&&r.html(oe),a.data("search-term",t),we=e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_search",search:t},function(s){r.html(s),we=!1,M(),e(".bpbm-gifs-icon").html(ge.gif)})))}),e(document).on("change keyup",".bpbm-search-in-list > input",function(s){var a=e(this),t=a.val().trim().toLowerCase(),i=a.parent().next();i.hasClass("threads-list")||i.find("> div").each(function(){var s=e(this);-1===s.find(".name").text().toLowerCase().indexOf(t)?s.hide():s.show()})}),e(document).on("click",".bpbm-send-files.bpbm-has-files",function(s){var a=e(this).closest(".uppy-Dashboard"),t=parseInt(a.attr("data-thread-id")),i=e("#bpbm-upload-btn-"+t);a.find(".uppy-Dashboard-close").click();i.closest("form").submit()}),e(document).on("bp-better-messages-open-mini-chat",function(e,s,a){S(s,a)}),e(document).on("bp-better-messages-open-private-thread",function(e,s){T(s)});var Pe,Me=[];e(window).resize(j),"1"===BP_Messages.enablePushNotifications&&(BPBMJQ(document).on("click",".BPBMenablePushNotifications",function(e){BPBMregisterPushWorker()}),BPBMJQ(document).on("click",".BPBMdisablePushNotifications",function(e){BPBMunregisterPushWorker()}))}(BPBMJQ);